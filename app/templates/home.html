{% extends "base_Admin.html" if admin_access else "base_home.html" %}

{% block content %}
<!-- Iconos flotantes de fondo -->
    <div class="floating-icons-container">
        <div class="floating-icon icon1">üìö</div>
        <div class="floating-icon icon2">üíª</div>
        <div class="floating-icon icon3">üéì</div>
        <div class="floating-icon icon4">‚úèÔ∏è</div>
        <div class="floating-icon icon5">üìê</div>
        <div class="floating-icon icon6">üî¨</div>
        <div class="floating-icon icon7">üé®</div>
        <div class="floating-icon icon8">üìù</div>
        <div class="floating-icon icon9">üîç</div>
        <div class="floating-icon icon10">üìä</div>
        <div class="floating-icon icon11">üí°</div>
        <div class="floating-icon icon12">‚öóÔ∏è</div>
        <div class="floating-icon icon13">üìì</div>
        <div class="floating-icon icon14">üßÆ</div>
        <div class="floating-icon icon15">üì±</div>
        <div class="floating-icon icon16">üéØ</div>
        <div class="floating-icon icon17">üìñ</div>
        <div class="floating-icon icon18">üîñ</div>
        <div class="floating-icon icon19">üìè</div>
        <div class="floating-icon icon20">üé≠</div>
    </div>
    
<!-- Contenido principal de la p√°gina de inicio -->
<div class="home-page-container">
    <!-- Secci√≥n Hero Principal -->
    <div class="home-hero-section hero-section">
        <div class="hero-content">
            <div class="hero-main">
                <h1 class="hero-title">
                    <i class="fas fa-graduation-cap"></i>
                    Portal Acad√©mico de Investigaci√≥n
                </h1>
                <p class="hero-subtitle">
                    Descubre recursos, conecta con investigadores y accede a laboratorios especializados 
                    para impulsar tu investigaci√≥n acad√©mica
                </p>
                
                <!-- B√∫squeda Global Principal Mejorada -->
                <div class="global-search-container">
                    <form class="global-search-form" id="globalSearchForm">
                        <div class="search-input-group">
                            <i class="fas fa-search search-icon" id="searchIcon"></i>
                            <input type="text" 
                                   id="globalSearchInput" 
                                   class="global-search-input" 
                                   placeholder="Buscar en laboratorios, proyectos, investigadores, instituciones..."
                                   autocomplete="off"
                                   spellcheck="false"
                                   role="searchbox"
                                   aria-label="B√∫squeda global en el portal"
                                   aria-describedby="search-help">
                            <button type="button" class="clear-global-search" id="clearGlobalSearch" style="display: none;" aria-label="Limpiar b√∫squeda">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
                        </div>
                        <!-- Filtros de B√∫squeda Mejorados y F√°ciles -->
                        <div class="search-filters-container">
                            <!-- Filtros R√°pidos Predefinidos -->
                            <div class="quick-filters-section">
                                <div class="quick-filters-header">
                                    <i class="fas fa-bolt"></i>
                                    <span>B√∫squedas R√°pidas</span>
                                    <div class="quick-filters-toggle" id="quickFiltersToggle">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div class="quick-filters-content" id="quickFiltersContent">
                                    <div class="quick-filter-chips">
                                        <button class="quick-filter-chip" data-quick-filter="labs-disponibles">
                                            <i class="fas fa-flask"></i>
                                            <span>Laboratorios Disponibles</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="proyectos-activos">
                                            <i class="fas fa-play-circle"></i>
                                            <span>Proyectos Activos</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="investigadores-recientes">
                                            <i class="fas fa-user-plus"></i>
                                            <span>Investigadores Nuevos</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="labs-grandes">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                            <span>Laboratorios Grandes (30+ personas)</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="proyectos-completados">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Proyectos Completados</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="mi-region">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>En Mi Regi√≥n</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="labs-especializados">
                                            <i class="fas fa-microscope"></i>
                                            <span>Labs Especializados</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="proyectos-recientes">
                                            <i class="fas fa-calendar-plus"></i>
                                            <span>Proyectos Recientes</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="alta-demanda">
                                            <i class="fas fa-fire"></i>
                                            <span>Alta Demanda</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="equipamiento-avanzado">
                                            <i class="fas fa-cogs"></i>
                                            <span>Equipamiento Avanzado</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="colaboraciones">
                                            <i class="fas fa-handshake"></i>
                                            <span>Colaboraciones Abiertas</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="financiamiento">
                                            <i class="fas fa-dollar-sign"></i>
                                            <span>Con Financiamiento</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="urgentes">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>Solicitudes Urgentes</span>
                                        </button>
                                        <button class="quick-filter-chip" data-quick-filter="multidisciplinario">
                                            <i class="fas fa-sitemap"></i>
                                            <span>Multidisciplinario</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Ayuda Contextual Mejorada -->
                            <div class="search-help-improved">
                                <div class="help-content">
                                    <i class="fas fa-lightbulb"></i>
                                    <span id="helpText">Usa los filtros r√°pidos arriba o personaliza tu b√∫squeda abajo</span>
                                </div>
                                <div class="help-actions">
                                    <button class="help-btn" id="showTutorialBtn" title="Ver tutorial">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                    <button class="help-btn" id="resetFiltersBtn" title="Limpiar todo">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtro Principal: Simple vs Avanzado -->
                            <div class="primary-filter">
                                <button type="button" class="filter-all-btn active" id="searchAllBtn">
                                    <i class="fas fa-search-plus"></i>
                                    <span>B√∫squeda Simple</span>
                                    <div class="filter-badge">R√°pido</div>
                                </button>
                                

                            </div>
                            
                            <!-- Separador -->
                            <div class="filter-separator" id="categoryFiltersSeparator">
                                <span>o selecciona categor√≠as espec√≠ficas</span>
                            </div>
                            
                            <!-- Filtros por Categor√≠a (B√∫squeda Simple) -->
                            <div class="category-filters" id="categoryFilters">
                                <button type="button" class="filter-category-btn" data-category="laboratorios" data-tooltip="Buscar solo en laboratorios disponibles">
                                    <div class="filter-icon">
                                        <i class="fas fa-flask"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Laboratorios</span>
                                        <span class="filter-count" id="count-laboratorios">{{ stats.laboratorios }}</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="filter-category-btn" data-category="proyectos" data-tooltip="Buscar en proyectos de investigaci√≥n">
                                    <div class="filter-icon">
                                        <i class="fas fa-project-diagram"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Proyectos</span>
                                        <span class="filter-count" id="count-proyectos">{{ stats.proyectos }}</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="filter-category-btn" data-category="investigadores" data-tooltip="Buscar investigadores y acad√©micos">
                                    <div class="filter-icon">
                                        <i class="fas fa-user-graduate"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Investigadores</span>
                                        <span class="filter-count" id="count-investigadores">{{ stats.investigadores }}</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="filter-category-btn" data-category="instituciones" data-tooltip="Buscar instituciones acad√©micas">
                                    <div class="filter-icon">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Instituciones</span>
                                        <span class="filter-count" id="count-instituciones">{{ stats.instituciones }}</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </button>
                                
                                <!-- Categor√≠as temporalmente deshabilitadas -->
                                <button type="button" class="filter-category-btn disabled" data-category="convocatorias" data-tooltip="Pr√≥ximamente disponible">
                                    <div class="filter-icon">
                                        <i class="fas fa-bullhorn"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Convocatorias</span>
                                        <span class="filter-count">0</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="filter-category-btn disabled" data-category="publicaciones" data-tooltip="Pr√≥ximamente disponible">
                                    <div class="filter-icon">
                                        <i class="fas fa-book-open"></i>
                                    </div>
                                    <div class="filter-content">
                                        <span class="filter-name">Publicaciones</span>
                                        <span class="filter-count">0</span>
                                    </div>
                                    <div class="filter-check">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </button>
                            </div>


                            
                            <!-- Resumen de Selecci√≥n -->
                            <div class="filter-summary" id="filterSummary" style="display: none;">
                                <div class="summary-content">
                                    <i class="fas fa-filter"></i>
                                    <span id="summaryText">Buscando en todas las categor√≠as</span>
                                </div>
                                <button type="button" class="clear-filters-btn" id="clearFiltersBtn" title="Limpiar filtros">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Panel de Filtros Guardados -->
                            <div class="saved-filters-panel" id="savedFiltersPanel" style="display: none;">
                                <div class="saved-filters-header">
                                    <h3><i class="fas fa-bookmark"></i> Mis Filtros Guardados</h3>
                                    <button type="button" class="btn-close-saved" id="closeSavedBtn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="saved-filters-content" id="savedFiltersContent">
                                    <div class="no-saved-filters">
                                        <i class="fas fa-bookmark"></i>
                                        <p>No tienes filtros guardados a√∫n</p>
                                        <small>Aplica filtros y gu√°rdalos para acceso r√°pido</small>
                                    </div>
                                </div>
                                <div class="saved-filters-actions">
                                    <button type="button" class="btn-save-current" id="saveCurrentBtn">
                                        <i class="fas fa-save"></i>
                                        Guardar Filtros Actuales
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="global-search-btn">
                    <i class="fas fa-search"></i>
                            <span>Buscar en Todo</span>
                </button>
                    </form>
                    
                    <!-- Resultados de B√∫squeda Global - Reposicionados -->
                    <div class="global-search-results-inline" id="searchResults" style="display: none;">
                        <div class="results-header-inline">
                            <h3>
                                <i class="fas fa-search"></i>
                                Resultados de B√∫squeda
                            </h3>
                            <button type="button" class="close-results-inline" id="closeResults">
                                <i class="fas fa-times"></i>
                            </button>
                </div>
                        
                        <div class="results-tabs-inline">
                            <button class="tab-btn-inline active" data-tab="all">
                                <i class="fas fa-list"></i>
                                <span>Todos</span>
                            </button>
                            <button class="tab-btn-inline" data-tab="laboratorios">
                                <i class="fas fa-flask"></i>
                                <span>Laboratorios</span>
                            </button>
                            <button class="tab-btn-inline" data-tab="proyectos">
                                <i class="fas fa-project-diagram"></i>
                                <span>Proyectos</span>
                            </button>
                            <button class="tab-btn-inline" data-tab="investigadores">
                                <i class="fas fa-user-tie"></i>
                                <span>Investigadores</span>
                            </button>
                            <button class="tab-btn-inline" data-tab="instituciones">
                                <i class="fas fa-university"></i>
                                <span>Instituciones</span>
                            </button>
            </div>
            
                        <div class="results-content-inline" id="resultsContent">
                            <!-- Los resultados se cargar√°n aqu√≠ din√°micamente -->
                            <div class="loading-state-inline">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Buscando en todas las categor√≠as...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estad√≠sticas Globales Mejoradas -->
            <div class="global-stats-enhanced main-content">
                <a href="{{ url_for('laboratorio.index') }}" class="stat-card-enhanced labs-card" data-category="laboratorios">
                    <div class="stat-card-background"></div>
                    <div class="stat-card-content">
                        <div class="stat-icon-enhanced">
                        <i class="fas fa-flask"></i>
                    </div>
                        <div class="stat-info-enhanced">
                            <div class="stat-number-enhanced">{{ stats.laboratorios }}</div>
                            <div class="stat-label-enhanced">Laboratorios</div>
                    </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                </div>
                    </div>
                    <div class="stat-card-hover-effect"></div>
                </a>
                
                <a href="{{ url_for('home.navegar_pagina', nombre='proyectos') }}" class="stat-card-enhanced projects-card" data-category="proyectos">
                    <div class="stat-card-background"></div>
                    <div class="stat-card-content">
                        <div class="stat-icon-enhanced">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                        <div class="stat-info-enhanced">
                            <div class="stat-number-enhanced">{{ stats.proyectos }}</div>
                            <div class="stat-label-enhanced">Proyectos</div>
                    </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                </div>
                    </div>
                    <div class="stat-card-hover-effect"></div>
                </a>
                
                <a href="{{ url_for('home.navegar_pagina', nombre='investigadores') }}" class="stat-card-enhanced researchers-card" data-category="investigadores">
                    <div class="stat-card-background"></div>
                    <div class="stat-card-content">
                        <div class="stat-icon-enhanced">
                        <i class="fas fa-user-tie"></i>
                    </div>
                        <div class="stat-info-enhanced">
                            <div class="stat-number-enhanced">{{ stats.investigadores }}</div>
                            <div class="stat-label-enhanced">Investigadores</div>
                    </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                </div>
                    </div>
                    <div class="stat-card-hover-effect"></div>
                </a>
                
                <a href="{{ url_for('home.navegar_pagina', nombre='instituciones') }}" class="stat-card-enhanced institutions-card" data-category="instituciones">
                    <div class="stat-card-background"></div>
                    <div class="stat-card-content">
                        <div class="stat-icon-enhanced">
                        <i class="fas fa-university"></i>
                    </div>
                        <div class="stat-info-enhanced">
                            <div class="stat-number-enhanced">{{ stats.instituciones }}</div>
                            <div class="stat-label-enhanced">Instituciones</div>
                    </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                </div>
                    </div>
                    <div class="stat-card-hover-effect"></div>
                </a>
            </div>
        </div>
    </div>

    <!-- Acceso R√°pido Mejorado -->
    <div class="quick-access-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-rocket"></i>
                Acceso R√°pido
            </h2>
            <p>Navega directamente a las secciones m√°s utilizadas</p>
        </div>
        
        <div class="quick-access-grid">
            <a href="{{ url_for('laboratorio.index') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="card-content">
                    <h3>Laboratorios</h3>
                    <p>Explora laboratorios especializados</p>
                    <span class="card-badge">{{ stats.laboratorios }}+ disponibles</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
            
            <a href="{{ url_for('home.navegar_pagina', nombre='proyectos') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="card-content">
                    <h3>Proyectos</h3>
                    <p>Descubre proyectos de investigaci√≥n</p>
                    <span class="card-badge">{{ stats.proyectos }}+ activos</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
            
            <a href="{{ url_for('home.navegar_pagina', nombre='investigadores') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="card-content">
                    <h3>Investigadores</h3>
                    <p>Conecta con expertos</p>
                    <span class="card-badge">{{ stats.investigadores }}+ perfiles</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
            
            <a href="{{ url_for('home.navegar_pagina', nombre='instituciones') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="card-content">
                    <h3>Instituciones</h3>
                    <p>Explora centros acad√©micos</p>
                    <span class="card-badge">{{ stats.instituciones }}+ instituciones</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
            
            <a href="{{ url_for('home.navegar_pagina', nombre='insumos') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <div class="card-content">
                    <h3>Materiales</h3>
                    <p>Encuentra recursos y equipos</p>
                    <span class="card-badge">1000+ items</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
            
            <a href="{{ url_for('home.navegar_pagina', nombre='servicios') }}" class="quick-access-card">
                <div class="card-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="card-content">
                    <h3>Servicios</h3>
                    <p>Accede a servicios especializados</p>
                    <span class="card-badge">100+ servicios</span>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </a>
        </div>
    </div>

    <!-- Secci√≥n de Categor√≠as Destacadas -->
    <div class="featured-categories-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-star"></i>
                √Åreas de Investigaci√≥n Destacadas
            </h2>
            <p>Explora las √°reas de investigaci√≥n m√°s activas</p>
        </div>
        
        <div class="categories-grid">
            {% if stats.areas_destacadas %}
                {% for area_name, total_labs in stats.areas_destacadas %}
                <div class="category-card {{ area_name.lower().replace(' ', '-') }}">
                <div class="category-overlay"></div>
                <div class="category-content">
                        {% if 'biotec' in area_name.lower() or 'bio' in area_name.lower() %}
                    <i class="fas fa-dna"></i>
                        {% elif 'inform' in area_name.lower() or 'comput' in area_name.lower() %}
                    <i class="fas fa-laptop-code"></i>
                        {% elif 'ingen' in area_name.lower() %}
                    <i class="fas fa-cogs"></i>
                        {% elif 'cienc' in area_name.lower() %}
                            <i class="fas fa-atom"></i>
                        {% else %}
                            <i class="fas fa-flask"></i>
                        {% endif %}
                        <h3>{{ area_name }}</h3>
                        <p>√Årea de investigaci√≥n especializada</p>
                    <div class="category-stats">
                            <span>{{ total_labs }} Laboratorios</span>
                    </div>
                </div>
            </div>
                {% endfor %}
            {% else %}
                <!-- Fallback si no hay datos -->
                <div class="category-card biotecnologia">
                <div class="category-overlay"></div>
                <div class="category-content">
                        <i class="fas fa-dna"></i>
                        <h3>Biotecnolog√≠a</h3>
                        <p>Investigaci√≥n en ciencias de la vida</p>
                    <div class="category-stats">
                            <span>-- Laboratorios</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>


</div>

<!-- JavaScript para funcionalidad -->
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const globalSearchInput = document.getElementById('globalSearchInput');
    const clearGlobalSearch = document.getElementById('clearGlobalSearch');
    const globalSearchForm = document.getElementById('globalSearchForm');
    const searchResults = document.getElementById('searchResults');
    const closeResults = document.getElementById('closeResults');
    const resultsContent = document.getElementById('resultsContent');
    const tabBtns = document.querySelectorAll('.tab-btn-inline');
    
    // Variables para b√∫squeda mejorada
    let searchTimeout;
    let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    let currentSuggestionIndex = -1;
    let selectedCategories = ['laboratorios', 'proyectos', 'investigadores', 'instituciones']; // Por defecto todas
    let searchAllMode = true; // Modo "Buscar en Todo" activo por defecto
    
    // Elementos del DOM
    const searchSuggestions = document.getElementById('searchSuggestions');
    const searchIcon = document.getElementById('searchIcon');
    
    // Nuevos elementos de filtros (se inicializar√°n en DOMContentLoaded)
    let searchAllBtn, categoryFilters, filterSummary, summaryText, clearFiltersBtn;
    
    // Mejorar funcionalidad del input de b√∫squeda
    globalSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Mostrar/ocultar bot√≥n de limpiar
        clearGlobalSearch.style.display = query ? 'block' : 'none';
        
        // B√∫squeda en tiempo real con debounce
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                showSearchSuggestions(query);
            }, 300);
            
            // Cambiar √≠cono a loading
            searchIcon.className = 'fas fa-spinner fa-spin search-icon';
        } else {
            hideSuggestions();
            searchIcon.className = 'fas fa-search search-icon';
        }
        
        // Cambiar color del borde seg√∫n el estado
        this.classList.toggle('has-content', query.length > 0);
    });
    
    // Navegaci√≥n por teclado en sugerencias
    globalSearchInput.addEventListener('keydown', function(e) {
        const suggestions = searchSuggestions.querySelectorAll('.suggestion-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, suggestions.length - 1);
            updateSuggestionSelection(suggestions);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
            updateSuggestionSelection(suggestions);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentSuggestionIndex >= 0 && suggestions[currentSuggestionIndex]) {
                selectSuggestion(suggestions[currentSuggestionIndex]);
            } else {
                submitSearch();
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });
    
    // Limpiar b√∫squeda mejorada
    clearGlobalSearch.addEventListener('click', function() {
        globalSearchInput.value = '';
        this.style.display = 'none';
        searchResults.style.display = 'none';
        hideSuggestions();
        globalSearchInput.focus();
        searchIcon.className = 'fas fa-search search-icon';
        globalSearchInput.classList.remove('has-content');
    });
    
    // Cerrar resultados
    closeResults.addEventListener('click', function() {
        searchResults.style.display = 'none';
        globalSearchInput.focus();
    });
    
    // Manejo de tabs mejorado
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const tab = this.dataset.tab;
            filterResults(tab);
            
            // Agregar efecto visual
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Env√≠o del formulario mejorado
    globalSearchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitSearch();
    });
        
    // Funci√≥n para enviar b√∫squeda
    function submitSearch() {
        const query = globalSearchInput.value.trim();
        if (!query) {
            showSearchError('Por favor ingresa un t√©rmino de b√∫squeda');
            return;
        }
        
        // Usar las categor√≠as seleccionadas seg√∫n el modo
        const categoriesToSearch = searchAllMode ? 
            ['laboratorios', 'proyectos', 'investigadores', 'instituciones'] : 
            selectedCategories;
        
        if (categoriesToSearch.length === 0) {
            showSearchError('Por favor selecciona al menos una categor√≠a para buscar');
            return;
        }
        
        // Agregar a historial
        addToSearchHistory(query);
        hideSuggestions();
        
        performGlobalSearch(query, categoriesToSearch);
    }
    
    // Funci√≥n para realizar b√∫squeda global
    function performGlobalSearch(query, categories) {
        console.log('üîç Iniciando b√∫squeda:', { query, categories });
        
        searchResults.style.display = 'block';
        
        // Generar pesta√±as din√°micas seg√∫n categor√≠as seleccionadas
        generateSearchTabs(categories);
        
        resultsContent.innerHTML = `
            <div class="loading-state-inline">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Buscando "${query}" en ${categories.join(', ')}...</p>
            </div>
        `;
        
        // Realizar b√∫squeda real en el backend
        const params = new URLSearchParams();
        params.append('q', query);
        categories.forEach(cat => params.append('categories', cat));
        
        const searchUrl = `{{ url_for('home.api_search') }}?${params}`;
        console.log('üì° URL de b√∫squeda:', searchUrl);
        
        fetch(searchUrl)
            .then(response => {
                console.log('üì• Respuesta recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `Error HTTP: ${response.status}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('üìä Datos recibidos:', data);
                
                if (data.success) {
                    displayResults(data.results, categories);
                    if (data.message) {
                        console.log('üí° Mensaje del servidor:', data.message);
                    }
                    
                    // Mostrar mensaje de resultados
                    if (data.total_results === 0) {
                        displayNoResults(query);
                    }
                } else {
                    displayError('Error en la b√∫squeda: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('‚ùå Error en b√∫squeda:', error);
                displayError('Error de b√∫squeda: ' + error.message);
            });
    }
    
    // Funci√≥n para generar pesta√±as din√°micas seg√∫n categor√≠as seleccionadas
    function generateSearchTabs(categories) {
        console.log('üè∑Ô∏è Generando pesta√±as para:', categories);
        
        const tabsContainer = document.querySelector('.results-tabs-inline');
        if (!tabsContainer) {
            console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor de pesta√±as');
            return;
        }
        
        let tabsHTML = '';
        
        // Pesta√±a "Todos" solo si hay m√°s de una categor√≠a
        if (categories.length > 1) {
            tabsHTML += `
                <button class="tab-btn-inline active" data-tab="all">
                    <i class="fas fa-list"></i>
                    <span>Todos</span>
                </button>
            `;
        }
        
        // Pesta√±as para cada categor√≠a seleccionada
        categories.forEach((category, index) => {
            const categoryInfo = getCategoryInfo(category);
            const isActive = categories.length === 1 ? 'active' : ''; // Si solo hay una categor√≠a, est√° activa
            
            tabsHTML += `
                <button class="tab-btn-inline ${isActive}" data-tab="${category}">
                    <i class="fas fa-${categoryInfo.icon}"></i>
                    <span>${categoryInfo.name}</span>
                </button>
            `;
        });
        
        tabsContainer.innerHTML = tabsHTML;
        
        // Reagregar event listeners a las nuevas pesta√±as
        const newTabBtns = tabsContainer.querySelectorAll('.tab-btn-inline');
        newTabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('üìã Click en pesta√±a:', this.dataset.tab);
                
                // Remover clase active de todas las pesta√±as
                newTabBtns.forEach(tab => tab.classList.remove('active'));
                
                // Agregar clase active a la pesta√±a clickeada
                this.classList.add('active');
                
                const tab = this.dataset.tab;
                filterResults(tab);
                
                // Agregar efecto visual
                this.style.transform = 'scale(0.95)';
        setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
        
        console.log('‚úÖ Pesta√±as generadas:', categories.length + (categories.length > 1 ? 1 : 0));
    }
    
    // Funci√≥n para obtener informaci√≥n de categor√≠a
    function getCategoryInfo(category) {
        const categoryMap = {
            'laboratorios': { name: 'Laboratorios', icon: 'flask' },
            'proyectos': { name: 'Proyectos', icon: 'project-diagram' },
            'investigadores': { name: 'Investigadores', icon: 'user-tie' },
            'instituciones': { name: 'Instituciones', icon: 'university' },
            'convocatorias': { name: 'Convocatorias', icon: 'bullhorn' },
            'publicaciones': { name: 'Publicaciones', icon: 'book' }
        };
        
        return categoryMap[category] || { name: category, icon: 'circle' };
    }
    
    // Funci√≥n para mostrar cuando no hay resultados
    function displayNoResults(query) {
        resultsContent.innerHTML = `
            <div class="no-results-inline">
                <i class="fas fa-search"></i>
                <h4>No se encontraron resultados</h4>
                <p>No se encontraron resultados para "${query}". Intenta con otros t√©rminos de b√∫squeda o selecciona diferentes categor√≠as.</p>
            </div>
        `;
    }
    
    // Funci√≥n para mostrar errores
    function displayError(message) {
        resultsContent.innerHTML = `
            <div class="error-state-inline">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Error en la b√∫squeda</h4>
                <p>${message}</p>
                <button onclick="searchResults.style.display='none'" class="btn-close-error-inline">
                    Cerrar
                </button>
            </div>
        `;
    }
    
    // Funci√≥n para mostrar errores de b√∫squeda
    function showSearchError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'search-error-toast';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(errorDiv);
        
        // Mostrar con animaci√≥n
        setTimeout(() => errorDiv.classList.add('show'), 100);
        
        // Ocultar despu√©s de 3 segundos
        setTimeout(() => {
            errorDiv.classList.remove('show');
            setTimeout(() => errorDiv.remove(), 300);
        }, 3000);
    }
    
    // Funci√≥n para mostrar sugerencias
    function showSearchSuggestions(query) {
        console.log('üí° Obteniendo sugerencias para:', query);
        
        // Combinar historial y sugerencias predefinidas como fallback
        const localSuggestions = [
            ...getHistorySuggestions(query),
            ...getPredefinedSuggestions(query)
        ];
        
        // Intentar obtener sugerencias del servidor
        const suggestionsUrl = `{{ url_for('home.api_search_suggestions') }}?q=${encodeURIComponent(query)}`;
        
        fetch(suggestionsUrl)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('No se pudieron cargar sugerencias del servidor');
                }
            })
            .then(data => {
                console.log('üí° Sugerencias del servidor:', data);
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    // Usar sugerencias del servidor + algunas locales
                    const serverSuggestions = data.suggestions.slice(0, 5);
                    const combinedSuggestions = [...serverSuggestions, ...localSuggestions.slice(0, 3)];
                    displaySuggestions(combinedSuggestions, query);
                } else {
                    displaySuggestions(localSuggestions, query);
                }
            })
            .catch(error => {
                console.log('‚ö†Ô∏è Usando sugerencias locales:', error.message);
                displaySuggestions(localSuggestions, query);
            });
    }
    
    // Funci√≥n auxiliar para mostrar las sugerencias
    function displaySuggestions(suggestions, query) {
        if (suggestions.length === 0) {
            hideSuggestions();
            searchIcon.className = 'fas fa-search search-icon';
            return;
        }
        
        // Limitar a 8 sugerencias m√°ximo
        const limitedSuggestions = suggestions.slice(0, 8);
        
        const suggestionsHTML = limitedSuggestions.map((suggestion, index) => `
            <div class="suggestion-item" data-index="${index}" data-query="${suggestion.text}">
                <i class="${suggestion.icon}"></i>
                <div class="suggestion-content">
                    <div class="suggestion-text">${highlightMatch(suggestion.text, query)}</div>
                    <div class="suggestion-category">${suggestion.category}</div>
                </div>
                <div class="suggestion-action">
                    <i class="fas fa-arrow-up-right"></i>
                </div>
            </div>
        `).join('');
        
        searchSuggestions.innerHTML = suggestionsHTML;
        searchSuggestions.style.display = 'block';
        currentSuggestionIndex = -1;
        
        // Agregar event listeners a las sugerencias
        searchSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => selectSuggestion(item));
            item.addEventListener('mouseenter', () => {
                currentSuggestionIndex = parseInt(item.dataset.index);
                updateSuggestionSelection(searchSuggestions.querySelectorAll('.suggestion-item'));
            });
        });
        
        searchIcon.className = 'fas fa-search search-icon';
    }
    
    // Funci√≥n para ocultar sugerencias
    function hideSuggestions() {
        searchSuggestions.style.display = 'none';
        currentSuggestionIndex = -1;
    }
    
    // Funci√≥n para actualizar selecci√≥n de sugerencias
    function updateSuggestionSelection(suggestions) {
        suggestions.forEach((item, index) => {
            item.classList.toggle('selected', index === currentSuggestionIndex);
        });
    }
    
    // Funci√≥n para seleccionar una sugerencia
    function selectSuggestion(item) {
        const query = item.dataset.query;
        globalSearchInput.value = query;
        hideSuggestions();
        submitSearch();
    }
    
    // Funci√≥n para obtener sugerencias del historial
    function getHistorySuggestions(query) {
        return searchHistory
            .filter(term => term.toLowerCase().includes(query.toLowerCase()))
            .slice(0, 3)
            .map(term => ({
                text: term,
                category: 'B√∫squeda reciente',
                icon: 'fas fa-history'
            }));
    }
    
    // Funci√≥n para obtener sugerencias predefinidas
    function getPredefinedSuggestions(query) {
        const predefined = [
            { text: 'laboratorio', category: 'Laboratorios', icon: 'fas fa-flask' },
            { text: 'proyecto', category: 'Proyectos', icon: 'fas fa-project-diagram' },
            { text: 'investigador', category: 'Investigadores', icon: 'fas fa-user-tie' },
            { text: 'instituci√≥n', category: 'Instituciones', icon: 'fas fa-university' },
            { text: 'biotecnolog√≠a', category: '√Årea de investigaci√≥n', icon: 'fas fa-dna' },
            { text: 'inform√°tica', category: '√Årea de investigaci√≥n', icon: 'fas fa-laptop-code' },
            { text: 'ingenier√≠a', category: '√Årea de investigaci√≥n', icon: 'fas fa-cogs' },
            { text: 'qu√≠mica', category: '√Årea de investigaci√≥n', icon: 'fas fa-atom' },
            { text: 'biolog√≠a', category: '√Årea de investigaci√≥n', icon: 'fas fa-microscope' }
        ];
        
        return predefined
            .filter(item => item.text.toLowerCase().includes(query.toLowerCase()))
            .slice(0, 5);
    }
    
    // Funci√≥n para resaltar coincidencias
    function highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }
    
    // Funci√≥n para agregar al historial
    function addToSearchHistory(query) {
        // Remover si ya existe
        searchHistory = searchHistory.filter(term => term.toLowerCase() !== query.toLowerCase());
        
        // Agregar al inicio
        searchHistory.unshift(query);
        
        // Limitar a 10 elementos
        searchHistory = searchHistory.slice(0, 10);
        
        // Guardar en localStorage
        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    }
    
    // Funci√≥n para limpiar historial
    function clearSearchHistory() {
        searchHistory = [];
        localStorage.removeItem('searchHistory');
    }
    
        // Funci√≥n para mostrar resultados (solo categor√≠as buscadas)
    function displayResults(results, searchedCategories) {
        console.log('üìä Mostrando resultados para categor√≠as:', searchedCategories);
        let html = '';
        
        // Solo mostrar las categor√≠as que fueron buscadas
        searchedCategories.forEach(category => {
            if (results[category] && results[category].length > 0) {
                html += `
                    <div class="result-category" data-category="${category}">
                        <h4 class="category-title">
                            <i class="fas fa-${getCategoryIcon(category)}"></i>
                            ${getCategoryName(category)} (${results[category].length})
                        </h4>
                        <div class="result-items">
                `;
                
                results[category].forEach(item => {
                    html += `
                        <div class="search-result-item" onclick="viewDetails('${category}', ${item.id})">
                            <div class="result-header">
                                <h5 class="result-title">${item.name}</h5>
                                <span class="result-type">${getCategoryName(category)}</span>
                            </div>
                            <p class="result-description">${item.description || item.specialty || 'Sin descripci√≥n disponible'}</p>
                                <div class="result-meta">
                                    ${item.institution ? `<span><i class="fas fa-university"></i> ${item.institution}</span>` : ''}
                                    ${item.leader ? `<span><i class="fas fa-user"></i> ${item.leader}</span>` : ''}
                                    ${item.location ? `<span><i class="fas fa-map-marker-alt"></i> ${item.location}</span>` : ''}
                                ${item.estatus ? `<span><i class="fas fa-info-circle"></i> ${item.estatus}</span>` : ''}
                                ${item.tipo ? `<span><i class="fas fa-tag"></i> ${item.tipo}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            } else if (results[category]) {
                // Mostrar mensaje para categor√≠as sin resultados
                html += `
                    <div class="result-category" data-category="${category}">
                        <h4 class="category-title">
                            <i class="fas fa-${getCategoryIcon(category)}"></i>
                            ${getCategoryName(category)} (0)
                        </h4>
                        <div class="result-items">
                            <div class="no-results-category">
                                <i class="fas fa-search"></i>
                                <p>No se encontraron resultados en ${getCategoryName(category)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        if (html === '') {
            html = `
                <div class="no-results-inline">
                    <i class="fas fa-search"></i>
                    <h4>No se encontraron resultados</h4>
                    <p>Intenta con otros t√©rminos de b√∫squeda o selecciona diferentes categor√≠as.</p>
                </div>
            `;
        }
        
        resultsContent.innerHTML = html;
        
        // Log de resultados mostrados
        const totalResults = searchedCategories.reduce((total, category) => {
            return total + (results[category] ? results[category].length : 0);
        }, 0);
        console.log('‚úÖ Resultados mostrados:', totalResults, 'en', searchedCategories.length, 'categor√≠as');
    }
    
    // Funci√≥n para filtrar resultados por tab
    function filterResults(tab) {
        const categories = document.querySelectorAll('.result-category');
        
        categories.forEach(category => {
            if (tab === 'all' || category.dataset.category === tab) {
                category.style.display = 'block';
            } else {
                category.style.display = 'none';
            }
        });
    }
    
    // Funciones auxiliares
    function getCategoryIcon(category) {
        const icons = {
            laboratorios: 'flask',
            proyectos: 'project-diagram',
            investigadores: 'user-tie',
            instituciones: 'university',
            convocatorias: 'bullhorn',
            publicaciones: 'book'
        };
        return icons[category] || 'circle';
    }
    
    function getCategoryName(category) {
        const names = {
            laboratorios: 'Laboratorios',
            proyectos: 'Proyectos',
            investigadores: 'Investigadores',
            instituciones: 'Instituciones',
            convocatorias: 'Convocatorias',
            publicaciones: 'Publicaciones'
        };
        return names[category] || category;
    }
    
    // Funci√≥n global para ver detalles
    window.viewDetails = function(category, id) {
        // Aqu√≠ redirigir√≠as a la p√°gina de detalles correspondiente
        if (category === 'laboratorios') {
            window.location.href = `/laboratorio/${id}`;
        } else {
            alert(`Ver detalles de ${category} ID: ${id}`);
        }
    };
        });
    
    // ========================================
    // FUNCIONALIDAD DE FILTROS MEJORADOS
    // ========================================
    
    // Inicializar filtros mejorados
    function initializeFilters() {
        console.log('üîß Inicializando filtros mejorados');
        
        // Obtener elementos del DOM
        searchAllBtn = document.getElementById('searchAllBtn');
        categoryFilters = document.getElementById('categoryFilters');
        filterSummary = document.getElementById('filterSummary');
        summaryText = document.getElementById('summaryText');
        clearFiltersBtn = document.getElementById('clearFiltersBtn');
        
        console.log('üîç Elementos encontrados:', {
            searchAllBtn: !!searchAllBtn,
            categoryFilters: !!categoryFilters,
            filterSummary: !!filterSummary,
            summaryText: !!summaryText,
            clearFiltersBtn: !!clearFiltersBtn
        });
        
        // Event listener para "Buscar en Todo"
        if (searchAllBtn) {
            searchAllBtn.addEventListener('click', function() {
                console.log('üéØ Click en "Buscar en Todo"');
                activateSearchAllMode();
            });
            console.log('‚úÖ Event listener agregado a "Buscar en Todo"');
        } else {
            console.error('‚ùå No se encontr√≥ el bot√≥n "Buscar en Todo"');
        }
        
        // Event listeners para filtros de categor√≠a
        if (categoryFilters) {
            const categoryButtons = categoryFilters.querySelectorAll('.filter-category-btn:not(.disabled)');
            console.log(`üè∑Ô∏è Encontrados ${categoryButtons.length} botones de categor√≠a`);
            
            categoryButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('üè∑Ô∏è Click en categor√≠a:', this.dataset.category);
                    toggleCategoryFilter(this);
                });
            });
            console.log('‚úÖ Event listeners agregados a botones de categor√≠a');
        } else {
            console.error('‚ùå No se encontr√≥ el contenedor de filtros de categor√≠a');
        }
        
        // Event listener para limpiar filtros
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                console.log('üßπ Click en limpiar filtros');
                clearAllFilters();
            });
            console.log('‚úÖ Event listener agregado a bot√≥n limpiar');
        } else {
            console.log('‚ÑπÔ∏è Bot√≥n limpiar no encontrado (normal si no hay filtros activos)');
        }
        
        // Inicializar tooltips para filtros
        initializeFilterTooltips();
        
        // Actualizar UI inicial
        updateFilterUI();
        updateSearchButtonText();
        
        console.log('‚úÖ Filtros inicializados correctamente');
    }
    
    // Activar modo "Buscar en Todo"
    function activateSearchAllMode() {
        console.log('üîç Activando modo "Buscar en Todo"');
        
        searchAllMode = true;
        selectedCategories = ['laboratorios', 'proyectos', 'investigadores', 'instituciones'];
        
        // Actualizar UI
        if (searchAllBtn) searchAllBtn.classList.add('active');
        
        // Desactivar filtros espec√≠ficos
        if (categoryFilters) {
            const categoryButtons = categoryFilters.querySelectorAll('.filter-category-btn');
            categoryButtons.forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        updateFilterUI();
        updateSearchButtonText();
    }
    
    // Toggle filtro de categor√≠a espec√≠fica
    function toggleCategoryFilter(button) {
        const category = button.dataset.category;
        
        if (button.classList.contains('disabled')) {
            showFilterTooltip(button, 'Esta categor√≠a estar√° disponible pr√≥ximamente');
            return;
        }
        
        console.log('üè∑Ô∏è Toggle filtro:', category);
        
        // Desactivar modo "Buscar en Todo"
        searchAllMode = false;
        if (searchAllBtn) searchAllBtn.classList.remove('active');
        
        // Toggle categor√≠a
        if (selectedCategories.includes(category)) {
            selectedCategories = selectedCategories.filter(cat => cat !== category);
            button.classList.remove('active');
        } else {
            selectedCategories.push(category);
            button.classList.add('active');
        }
        
        // Si no hay categor√≠as seleccionadas, volver a "Buscar en Todo"
        if (selectedCategories.length === 0) {
            activateSearchAllMode();
            return;
        }
        
        updateFilterUI();
        updateSearchButtonText();
    }
    
    // Limpiar todos los filtros
    function clearAllFilters() {
        console.log('üßπ Limpiando todos los filtros');
        activateSearchAllMode();
    }
    
    // Actualizar UI de filtros
    function updateFilterUI() {
        if (!filterSummary || !summaryText) return;
        
        if (searchAllMode) {
            filterSummary.style.display = 'none';
        } else {
            filterSummary.style.display = 'flex';
            
            const categoryNames = selectedCategories.map(cat => {
                const categoryMap = {
                    'laboratorios': 'Laboratorios',
                    'proyectos': 'Proyectos', 
                    'investigadores': 'Investigadores',
                    'instituciones': 'Instituciones',
                    'convocatorias': 'Convocatorias',
                    'publicaciones': 'Publicaciones'
                };
                return categoryMap[cat] || cat;
            });
            
            if (categoryNames.length === 1) {
                summaryText.textContent = `Buscando solo en ${categoryNames[0]}`;
            } else if (categoryNames.length === 2) {
                summaryText.textContent = `Buscando en ${categoryNames.join(' y ')}`;
            } else {
                summaryText.textContent = `Buscando en ${categoryNames.length} categor√≠as seleccionadas`;
            }
        }
    }
    
    // Actualizar texto del bot√≥n de b√∫squeda
    function updateSearchButtonText() {
        const searchBtn = document.querySelector('.global-search-btn span');
        if (!searchBtn) {
            console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n de b√∫squeda para actualizar texto');
            return;
        }
        
        let newText = '';
        if (searchAllMode) {
            newText = 'Buscar en Todo';
        } else if (selectedCategories.length === 1) {
            const categoryMap = {
                'laboratorios': 'Laboratorios',
                'proyectos': 'Proyectos',
                'investigadores': 'Investigadores', 
                'instituciones': 'Instituciones'
            };
            newText = `Buscar en ${categoryMap[selectedCategories[0]]}`;
        } else {
            newText = `Buscar en ${selectedCategories.length} Categor√≠as`;
        }
        
        searchBtn.textContent = newText;
        console.log('üîÑ Texto del bot√≥n actualizado:', newText);
    }
    
    // Inicializar tooltips para filtros
    function initializeFilterTooltips() {
        const filterButtons = document.querySelectorAll('.filter-category-btn[data-tooltip]');
        
        filterButtons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                showFilterTooltip(this, this.dataset.tooltip);
            });
            
            button.addEventListener('mouseleave', function() {
                hideFilterTooltip();
            });
        });
    }
    
    // Mostrar tooltip de filtro
    function showFilterTooltip(element, text) {
        // Crear tooltip si no existe
        let tooltip = document.getElementById('filterTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'filterTooltip';
            tooltip.className = 'filter-tooltip';
            document.body.appendChild(tooltip);
        }
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        
        // Posicionar tooltip
        const rect = element.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';
        
        // Animar entrada
        tooltip.style.opacity = '0';
        tooltip.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            tooltip.style.opacity = '1';
            tooltip.style.transform = 'translateY(0)';
        }, 10);
    }
    
    // Ocultar tooltip de filtro
    function hideFilterTooltip() {
        const tooltip = document.getElementById('filterTooltip');
        if (tooltip) {
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 200);
        }
    }
    
    // ========================================
    // FUNCIONALIDAD DE FILTROS AVANZADOS
    // ========================================
    
    // Variables globales para filtros avanzados (deshabilitadas)
    // let advancedSearchBtn, advancedFiltersPanel, closeAdvancedBtn, applyAdvancedBtn, clearAllAdvancedBtn;
    // let currentAdvancedFilters = {};
    let isAdvancedMode = false; // Mantenemos esta para compatibilidad
    let filterData = null;
    
    // Variables de optimizaci√≥n
    let searchCache = new Map();
    let searchDebounceTimer = null;
    let lastSearchQuery = '';
    let searchRequestController = null;
    let filterPerformanceMetrics = {
        searches: 0,
        cacheHits: 0,
        averageResponseTime: 0,
        totalResponseTime: 0
    };
    
    // Configuraci√≥n de optimizaci√≥n
    const SEARCH_CONFIG = {
        debounceDelay: 300,
        cacheMaxSize: 50,
        cacheExpiration: 5 * 60 * 1000, // 5 minutos
        maxRetries: 3,
        retryDelay: 1000
    };
    
    // Inicializar filtros avanzados (DESHABILITADO - Bot√≥n eliminado)
    /*
    function initializeAdvancedFilters() {
        console.log('üîß Inicializando filtros avanzados');
        
        // Obtener elementos del DOM
        advancedSearchBtn = document.getElementById('advancedSearchBtn');
        advancedFiltersPanel = document.getElementById('advancedFiltersPanel');
        closeAdvancedBtn = document.getElementById('closeAdvancedBtn');
        applyAdvancedBtn = document.getElementById('applyAdvancedBtn');
        clearAllAdvancedBtn = document.getElementById('clearAllAdvancedBtn');
        
        console.log('üîç Elementos avanzados encontrados:', {
            advancedSearchBtn: !!advancedSearchBtn,
            advancedFiltersPanel: !!advancedFiltersPanel,
            closeAdvancedBtn: !!closeAdvancedBtn,
            applyAdvancedBtn: !!applyAdvancedBtn,
            clearAllAdvancedBtn: !!clearAllAdvancedBtn
        });
        
        // Event listeners para filtros avanzados
        if (advancedSearchBtn) {
            advancedSearchBtn.addEventListener('click', function() {
                console.log('üéØ Click en "Filtros Avanzados"');
                toggleAdvancedMode();
            });
        }
        
        if (closeAdvancedBtn) {
            closeAdvancedBtn.addEventListener('click', function() {
                console.log('‚ùå Cerrando filtros avanzados');
                hideAdvancedPanel();
            });
        }
        
        if (applyAdvancedBtn) {
            applyAdvancedBtn.addEventListener('click', function() {
                console.log('‚úÖ Aplicando filtros avanzados');
                applyAdvancedFilters();
            });
        }
        
        if (clearAllAdvancedBtn) {
            clearAllAdvancedBtn.addEventListener('click', function() {
                console.log('üßπ Limpiando todos los filtros avanzados');
                clearAllAdvancedFilters();
            });
        }
        
        // Cargar datos para filtros (funci√≥n simplificada)
        function loadFilterData() {
            console.log('üìä Datos de filtros cargados (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        loadFilterData();
        
        // Inicializar event listeners para controles din√°micos (funci√≥n simplificada)
        function initializeAdvancedControls() {
            console.log('üéõÔ∏è Controles avanzados inicializados (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        initializeAdvancedControls();
    }
    */
    
    // Alternar modo avanzado
    function toggleAdvancedMode() {
        if (isAdvancedMode) {
            hideAdvancedPanel();
        } else {
            showAdvancedPanel();
        }
    }
    
    // Mostrar panel avanzado
    function showAdvancedPanel() {
        console.log('üìä Mostrando panel de filtros avanzados');
        
        isAdvancedMode = true;
        
        // Actualizar estado de botones
        if (searchAllBtn) searchAllBtn.classList.remove('active');
        if (advancedSearchBtn) advancedSearchBtn.classList.add('active');
        
        // Ocultar filtros simples
        const categoryFiltersSeparator = document.getElementById('categoryFiltersSeparator');
        const categoryFilters = document.getElementById('categoryFilters');
        
        if (categoryFiltersSeparator) categoryFiltersSeparator.style.display = 'none';
        if (categoryFilters) categoryFilters.style.display = 'none';
        
        // Mostrar panel avanzado
        if (advancedFiltersPanel) {
            advancedFiltersPanel.style.display = 'block';
            // Trigger reflow para animaci√≥n
            advancedFiltersPanel.offsetHeight;
        }
        
        // Actualizar texto del bot√≥n de b√∫squeda
        updateSearchButtonText();
        
        console.log('‚úÖ Panel avanzado mostrado');
    }
    
    // Ocultar panel avanzado (funci√≥n simplificada)
    function hideAdvancedPanel() {
        console.log('üìä Ocultando panel de filtros avanzados (simplificado)');
        // Esta funci√≥n se simplific√≥ ya que no hay panel avanzado
    }
    
    // Cargar datos para poblar filtros
    function loadFilterData() {
        console.log('üìã Cargando datos para filtros...');
        
        fetch('/api/filters/data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filterData = data.data;
                    console.log('üìã Datos de filtros cargados:', filterData);
                    populateFilterSelects();
                } else {
                    console.error('‚ùå Error cargando datos de filtros:', data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Error en petici√≥n de datos de filtros:', error);
            });
    }
    
    // Poblar selects con datos
    function populateFilterSelects() {
        console.log('üîÑ Poblando selects de filtros...');
        
        if (!filterData) return;
        
        // Poblar estados
        const estadoSelect = document.getElementById('filterEstado');
        if (estadoSelect && filterData.estados) {
            filterData.estados.forEach(estado => {
                const option = document.createElement('option');
                option.value = estado;
                option.textContent = estado;
                estadoSelect.appendChild(option);
            });
        }
        
        // Poblar √°reas
        const areaSelect = document.getElementById('filterArea');
        if (areaSelect && filterData.areas) {
            filterData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id_area;
                option.textContent = area.nombre_area;
                areaSelect.appendChild(option);
            });
        }
        
        // Poblar instituciones
        const institucionSelect = document.getElementById('filterInstitucion');
        if (institucionSelect && filterData.instituciones) {
            filterData.instituciones.forEach(institucion => {
                const option = document.createElement('option');
                option.value = institucion.id_institucion;
                option.textContent = institucion.nombre_institucion;
                institucionSelect.appendChild(option);
            });
        }
        
        console.log('‚úÖ Selects poblados correctamente');
    }
    
    // Inicializar controles din√°micos
    function initializeAdvancedControls() {
        // Event listener para cambio de estado
        const estadoSelect = document.getElementById('filterEstado');
        const municipioSelect = document.getElementById('filterMunicipio');
        
        if (estadoSelect && municipioSelect) {
            estadoSelect.addEventListener('change', function() {
                updateMunicipios(this.value);
            });
        }
        
        // Event listener para per√≠odo predefinido
        const periodoSelect = document.getElementById('filterPeriodo');
        const fechaDesdeInput = document.getElementById('filterFechaDesde');
        const fechaHastaInput = document.getElementById('filterFechaHasta');
        
        if (periodoSelect && fechaDesdeInput && fechaHastaInput) {
            periodoSelect.addEventListener('change', function() {
                if (this.value) {
                    const dateRange = getDateRangeFromPeriod(this.value);
                    fechaDesdeInput.value = dateRange.desde;
                    fechaHastaInput.value = dateRange.hasta;
                } else {
                    fechaDesdeInput.value = '';
                    fechaHastaInput.value = '';
                }
            });
        }
    }
    
    // Actualizar municipios basado en estado seleccionado
    function updateMunicipios(estado) {
        const municipioSelect = document.getElementById('filterMunicipio');
        if (!municipioSelect || !filterData || !filterData.municipios) return;
        
        // Limpiar opciones actuales
        municipioSelect.innerHTML = '<option value="">Todos los municipios</option>';
        
        // Filtrar municipios por estado
        const municipiosDelEstado = filterData.municipios.filter(m => m.estado === estado);
        
        municipiosDelEstado.forEach(municipio => {
            const option = document.createElement('option');
            option.value = municipio.municipio;
            option.textContent = municipio.municipio;
            municipioSelect.appendChild(option);
        });
        
        console.log(`üèõÔ∏è Municipios actualizados para ${estado}: ${municipiosDelEstado.length}`);
    }
    
    // Obtener rango de fechas desde per√≠odo predefinido
    function getDateRangeFromPeriod(period) {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        let desde = '';
        
        switch (period) {
            case 'ultima_semana':
                desde = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case 'ultimo_mes':
                desde = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case 'ultimos_3_meses':
                desde = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case 'ultimo_ano':
                desde = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
        }
        
        return { desde, hasta: today };
    }
    
    // Recopilar filtros avanzados del formulario
    function collectAdvancedFilters() {
        const filters = {};
        
        // Obtener categor√≠as seleccionadas
        const categoryCheckboxes = document.querySelectorAll('.filter-checkboxes input[type="checkbox"]:checked');
        filters.categories = Array.from(categoryCheckboxes).map(cb => cb.value);
        
        // Obtener filtros de ubicaci√≥n
        filters.estado = document.getElementById('filterEstado')?.value || '';
        filters.municipio = document.getElementById('filterMunicipio')?.value || '';
        filters.ubicacion = document.getElementById('filterUbicacion')?.value || '';
        
        // Obtener filtros de √°rea e instituci√≥n
        filters.area = document.getElementById('filterArea')?.value || '';
        filters.institucion = document.getElementById('filterInstitucion')?.value || '';
        filters.tipo_institucion = document.getElementById('filterTipoInstitucion')?.value || '';
        
        // Obtener filtros de laboratorio
        filters.capacidad_min = document.getElementById('filterCapacidadMin')?.value || '';
        filters.capacidad_max = document.getElementById('filterCapacidadMax')?.value || '';
        filters.superficie_min = document.getElementById('filterSuperficie')?.value || '';
        filters.equipamiento = document.getElementById('filterEquipamiento')?.value || '';
        filters.disponibilidad = document.getElementById('filterDisponibilidad')?.value || '';
        filters.requiere_capacitacion = document.getElementById('filterCapacitacion')?.checked || false;
        
        // Obtener filtros de proyecto
        filters.tipo_proyecto = document.getElementById('filterTipoProyecto')?.value || '';
        filters.estatus_proyecto = document.getElementById('filterEstatusProyecto')?.value || '';
        filters.con_adjuntos = document.getElementById('filterConAdjuntos')?.checked || false;
        
        // Obtener filtros de fecha
        filters.fecha_desde = document.getElementById('filterFechaDesde')?.value || '';
        filters.fecha_hasta = document.getElementById('filterFechaHasta')?.value || '';
        filters.periodo = document.getElementById('filterPeriodo')?.value || '';
        
        return filters;
    }
    
    // Aplicar filtros avanzados
    function applyAdvancedFilters() {
        console.log('üîç Aplicando filtros avanzados...');
        
        const query = searchInput.value.trim();
        const filters = collectAdvancedFilters();
        
        console.log('üìä Filtros recopilados:', filters);
        
        // Validar que hay al menos algo para buscar
        if (!query && !filters.categories.length && !hasAnyFilter(filters)) {
            showToast('Por favor ingresa un t√©rmino de b√∫squeda o selecciona al menos un filtro', 'warning');
            return;
        }
        
        // Validar que hay categor√≠as seleccionadas
        if (!filters.categories.length) {
            showToast('Selecciona al menos una categor√≠a para buscar', 'warning');
            return;
        }
        
        currentAdvancedFilters = filters;
        
        // Mostrar indicador de carga
        showLoadingState();
        
        // Construir URL con par√°metros
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        
        // Agregar categor√≠as
        filters.categories.forEach(cat => params.append('categories', cat));
        
        // Agregar otros filtros
        Object.keys(filters).forEach(key => {
            if (key !== 'categories' && filters[key]) {
                if (typeof filters[key] === 'boolean') {
                    params.append(key, filters[key] ? 'true' : 'false');
                } else {
                    params.append(key, filters[key]);
                }
            }
        });
        
        const url = `/api/search/advanced?${params.toString()}`;
        console.log('üì° URL de b√∫squeda avanzada:', url);
        
        // Realizar b√∫squeda
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('üìä Respuesta de b√∫squeda avanzada:', data);
                hideLoadingState();
                
                if (data.success) {
                    // Mostrar resultados
                    displayAdvancedResults(data.results, data.categories, data.query);
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error || 'Error en la b√∫squeda avanzada', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error en b√∫squeda avanzada:', error);
                hideLoadingState();
                showToast('Error de conexi√≥n. Intenta nuevamente.', 'error');
            });
    }
    
    // Verificar si hay alg√∫n filtro aplicado
    function hasAnyFilter(filters) {
        const filterKeys = Object.keys(filters).filter(key => key !== 'categories');
        return filterKeys.some(key => {
            const value = filters[key];
            return value && value !== '' && value !== false;
        });
    }
    
    // Mostrar resultados de b√∫squeda avanzada
    function displayAdvancedResults(results, searchedCategories, query) {
        console.log('üìä Mostrando resultados avanzados para categor√≠as:', searchedCategories);
        
        // Usar la funci√≥n de display existente pero con modificaciones
        generateSearchTabs(searchedCategories);
        displayResults(results, searchedCategories);
        
        // Mostrar contenedor de resultados
        if (searchResults) {
            searchResults.style.display = 'block';
        }
        
        // Actualizar header con informaci√≥n de filtros
        updateResultsHeader(query, searchedCategories, true);
    }
    
    // Actualizar header de resultados
    function updateResultsHeader(query, categories, isAdvanced = false) {
        const resultsHeader = document.querySelector('.results-header-inline h3');
        if (resultsHeader) {
            const modeText = isAdvanced ? 'B√∫squeda Avanzada' : 'B√∫squeda Simple';
            const queryText = query ? `"${query}"` : 'Sin t√©rmino espec√≠fico';
            const categoriesText = categories.length === 1 ? categories[0] : `${categories.length} categor√≠as`;
            
            resultsHeader.innerHTML = `
                <i class="fas fa-${isAdvanced ? 'sliders-h' : 'search'}"></i>
                ${modeText}: ${queryText} en ${categoriesText}
            `;
        }
    }
    
    // Limpiar todos los filtros avanzados (funci√≥n simplificada)
    function clearAllAdvancedFilters() {
        console.log('üßπ Limpiando todos los filtros avanzados (simplificado)');
        // Esta funci√≥n se simplific√≥ ya que no hay filtros avanzados
    }
    
    // Actualizar texto del bot√≥n de b√∫squeda (funci√≥n simplificada)
    function updateSearchButtonText() {
        console.log('üî§ Texto del bot√≥n de b√∫squeda actualizado (simplificado)');
        // Esta funci√≥n se simplific√≥ ya que no hay bot√≥n de b√∫squeda avanzada
    }
    
    // Inicializar filtros cuando se carga el DOM (funci√≥n simplificada)
    function initializeFilters() {
        console.log('üîß Filtros b√°sicos inicializados (simplificado)');
        // Esta funci√≥n se simplific√≥ para evitar dependencias
    }
    initializeFilters();
    
    // Inicializar filtros avanzados
    // initializeAdvancedFilters(); // Deshabilitado - bot√≥n eliminado
    
    // ========================================
    // FUNCIONALIDADES PARA FACILITAR USO
    // ========================================
    
    // Variables para funcionalidades f√°ciles
    let quickFiltersToggle, quickFiltersContent, showTutorialBtn, resetFiltersBtn;
    let savedFiltersPanel, saveCurrentBtn, tutorialModal;
    let currentTutorialStep = 1;
    let savedFilters = JSON.parse(localStorage.getItem('savedFilters') || '[]');
    
    // Inicializar funcionalidades f√°ciles
    function initializeEasyFeatures() {
        console.log('‚ú® Inicializando funcionalidades f√°ciles');
        
        // Obtener elementos del DOM
        quickFiltersToggle = document.getElementById('quickFiltersToggle');
        quickFiltersContent = document.getElementById('quickFiltersContent');
        showTutorialBtn = document.getElementById('showTutorialBtn');
        resetFiltersBtn = document.getElementById('resetFiltersBtn');
        savedFiltersPanel = document.getElementById('savedFiltersPanel');
        saveCurrentBtn = document.getElementById('saveCurrentBtn');
        tutorialModal = document.getElementById('tutorialModal');
        
        // Event listeners para filtros r√°pidos
        if (quickFiltersToggle) {
            quickFiltersToggle.addEventListener('click', toggleQuickFilters);
            
            // Asegurar que los filtros est√©n ocultos por defecto
            if (quickFiltersContent) {
                quickFiltersContent.style.display = 'none';
                quickFiltersContent.style.opacity = '0';
                quickFiltersContent.style.transform = 'translateY(-10px)';
                quickFiltersContent.classList.remove('expanded');
                quickFiltersToggle.classList.remove('expanded');
            }
        }
        
        // Event listeners para botones de ayuda
        if (showTutorialBtn) {
            showTutorialBtn.addEventListener('click', showTutorial);
        }
        
        // Funci√≥n para mostrar tutorial (simplificada)
        function showTutorial() {
            console.log('üìö Mostrando tutorial (simplificado)');
            showToast('Tutorial no implementado', 'info');
        }
        
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', resetAllFilters);
        }
        
        // Event listeners para filtros guardados
        if (saveCurrentBtn) {
            saveCurrentBtn.addEventListener('click', saveCurrentFilters);
        }
        
        // Funci√≥n para guardar filtros actuales (simplificada)
        function saveCurrentFilters() {
            console.log('üíæ Guardando filtros actuales (simplificado)');
            showToast('Funci√≥n de guardar filtros no implementada', 'info');
        }
        
        // Event listeners para filtros r√°pidos
        const quickFilterChips = document.querySelectorAll('.quick-filter-chip');
        quickFilterChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const filterType = this.getAttribute('data-quick-filter');
                
                // Si el chip ya est√° activo, desactivarlo
                if (this.classList.contains('active')) {
                    console.log(`üîÑ Desactivando filtro: ${filterType}`);
                    resetAllFilters();
                    return;
                }
                
                // Aplicar el filtro
                applyQuickFilter(filterType);
            });
        });
        
        // Inicializar tutorial (funci√≥n simplificada)
        function initializeTutorial() {
            console.log('üìö Tutorial inicializado (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        initializeTutorial();
        
        // Inicializar autocompletado (funci√≥n simplificada)
        function initializeAutocomplete() {
            console.log('üî§ Autocompletado inicializado (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        initializeAutocomplete();
        
        // Cargar filtros guardados (funci√≥n simplificada)
        function loadSavedFilters() {
            console.log('üíæ Filtros guardados cargados (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        loadSavedFilters();
        
        // Inicializar optimizaciones (funci√≥n simplificada)
        function initializeOptimizations() {
            console.log('‚ö° Optimizaciones inicializadas (simplificado)');
            // Esta funci√≥n se simplific√≥ para evitar dependencias
        }
        initializeOptimizations();
        
        console.log('‚ú® Funcionalidades f√°ciles inicializadas');
    }
    
    // Alternar filtros r√°pidos
    function toggleQuickFilters() {
        if (!quickFiltersContent) return;
        
        const isExpanded = quickFiltersContent.style.display !== 'none';
        const toggleIcon = quickFiltersToggle.querySelector('i');
        
        if (isExpanded) {
            // Ocultar filtros
            quickFiltersContent.style.display = 'none';
            quickFiltersContent.style.opacity = '0';
            quickFiltersContent.style.transform = 'translateY(-10px)';
            
            // Cambiar icono
            toggleIcon.className = 'fas fa-chevron-down';
            
            // A√±adir clase para animaci√≥n
            quickFiltersContent.classList.remove('expanded');
            quickFiltersToggle.classList.remove('expanded');
            
            // Estado silencioso: sin notificaci√≥n
            
            console.log('üìÅ Filtros r√°pidos ocultados');
        } else {
            // Mostrar filtros
            quickFiltersContent.style.display = 'block';
            
            // Trigger reflow para animaci√≥n
            quickFiltersContent.offsetHeight;
            
            // Animar entrada
            quickFiltersContent.style.opacity = '1';
            quickFiltersContent.style.transform = 'translateY(0)';
            
            // Cambiar icono
            toggleIcon.className = 'fas fa-chevron-up';
            
            // A√±adir clase para animaci√≥n
            quickFiltersContent.classList.add('expanded');
            quickFiltersToggle.classList.add('expanded');
            
            // Estado silencioso: sin notificaci√≥n
            
            console.log('üìÇ Filtros r√°pidos mostrados');
        }
    }
    
    // Aplicar filtro r√°pido
    function applyQuickFilter(filterType) {
        console.log(`‚ö° Aplicando filtro r√°pido: ${filterType}`);
        
        // Resetear filtros primero
        resetAllFilters();
        
        // Los filtros r√°pidos funcionan sin necesidad de query de b√∫squeda
        let searchQuery = ''; // Vac√≠o intencionalmente - los filtros son suficientes
        let categories = [];
        let advancedFilters = {};
        
        // Reducir ruido: no mostrar toast por cada click de chip
        
        // Mostrar indicador de carga inmediatamente
        showLoadingState();
        
        switch (filterType) {
            case 'labs-disponibles':
                categories = ['laboratorios'];
                advancedFilters.disponibilidad = 'Disponible';
                updateHelpText('Buscando laboratorios disponibles...');
                break;
                
            case 'proyectos-activos':
                categories = ['proyectos'];
                advancedFilters.estatus_proyecto = 'En Desarrollo';
                updateHelpText('Buscando proyectos en desarrollo...');
                break;
                
            case 'investigadores-recientes':
                categories = ['investigadores'];
                advancedFilters.periodo = 'ultimos_3_meses';
                updateHelpText('Buscando investigadores registrados recientemente...');
                break;
                
            case 'labs-grandes':
                categories = ['laboratorios'];
                advancedFilters.capacidad_min = '30';
                updateHelpText('Buscando laboratorios con capacidad para 30+ personas...');
                break;
                
            case 'proyectos-completados':
                categories = ['proyectos'];
                advancedFilters.estatus_proyecto = 'Completado';
                updateHelpText('Buscando proyectos completados...');
                break;
                
            case 'mi-region':
                // Intentar obtener regi√≥n del usuario
                const userRegion = getUserRegion();
                if (userRegion) {
                    categories = ['laboratorios', 'investigadores', 'instituciones'];
                    advancedFilters.estado = userRegion;
                    updateHelpText(`Buscando recursos en ${userRegion}...`);
                } else {
                    showToast('No se pudo determinar tu regi√≥n. Config√∫rala en tu perfil.', 'warning');
                    return;
                }
                break;
                
            case 'labs-especializados':
                categories = ['laboratorios'];
                advancedFilters.requiere_capacitacion = 'true';
                advancedFilters.equipamiento = 'especial';
                updateHelpText('Buscando laboratorios especializados...');
                break;
                
            case 'proyectos-recientes':
                categories = ['proyectos'];
                const fechaReciente = new Date();
                fechaReciente.setMonth(fechaReciente.getMonth() - 2);
                advancedFilters.fecha_desde = fechaReciente.toISOString().split('T')[0];
                updateHelpText('Buscando proyectos iniciados en los √∫ltimos 2 meses...');
                break;
                
            case 'alta-demanda':
                categories = ['laboratorios'];
                advancedFilters.disponibilidad = 'Disponible';
                updateHelpText('Buscando laboratorios con alta demanda (aprox. disponibles)...');
                break;
                
            case 'equipamiento-avanzado':
                categories = ['laboratorios'];
                advancedFilters.equipamiento = 'avanzado';
                advancedFilters.requiere_capacitacion = 'true';
                updateHelpText('Buscando laboratorios con equipamiento de √∫ltima generaci√≥n...');
                break;
                
            case 'colaboraciones':
                categories = ['proyectos'];
                advancedFilters.tipo_proyecto = 'Colaboraci√≥n';
                updateHelpText('Buscando oportunidades de colaboraci√≥n abiertas...');
                break;
                
            case 'financiamiento':
                categories = ['proyectos'];
                advancedFilters.con_adjuntos = 'true';
                updateHelpText('Buscando proyectos con documentaci√≥n/financiamiento adjunto...');
                break;
                
            case 'urgentes':
                categories = ['proyectos'];
                advancedFilters.periodo = 'ultima_semana';
                updateHelpText('Buscando proyectos recientes (√∫ltima semana)...');
                break;
                
            case 'multidisciplinario':
                categories = ['proyectos'];
                advancedFilters.tipo_proyecto = 'Multidisciplinario';
                updateHelpText('Buscando proyectos multidisciplinarios...');
                break;
        }
        
        // Limpiar la barra de b√∫squeda para mostrar que el filtro es independiente
        const searchInput = document.getElementById('globalSearchInput');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Aplicar el filtro (sin query, solo con filtros espec√≠ficos)
        performQuickSearch(searchQuery, categories, advancedFilters);
        
        // Marcar el chip como activo
        document.querySelectorAll('.quick-filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        const activeChip = document.querySelector(`[data-quick-filter="${filterType}"]`);
        if (activeChip) {
            activeChip.classList.add('active');
        }
        
        // Mantener la interfaz clara sin notificaci√≥n redundante
        
        // Actualizar interfaz para mostrar que hay filtros activos
        updateFilterActiveState(true);
        
        // Actualizar texto de ayuda para mostrar el filtro activo
        const filterName = activeChip?.textContent || filterType;
        updateHelpText(`Filtro activo: ${filterName} - Los resultados se muestran abajo`);
        
        // Actualizar contador de filtros activos
        updateActiveFiltersCounter(1);
        
        // Ya no ocultamos autom√°ticamente para que el usuario pueda cambiar de chip
    }
    
    // Actualizar estado visual de filtros activos
    function updateFilterActiveState(hasActiveFilters) {
        const quickFiltersHeader = document.querySelector('.quick-filters-header');
        const searchContainer = document.querySelector('.search-container');
        
        if (hasActiveFilters) {
            // Agregar indicador visual de filtros activos
            if (quickFiltersHeader) {
                quickFiltersHeader.classList.add('filters-active');
                quickFiltersHeader.title = 'Filtros activos - Click para ver detalles';
            }
            
            // Agregar clase para indicar filtros activos
            if (searchContainer) {
                searchContainer.classList.add('filters-active');
            }
            
            // Sin toast; el header y contador ya informan el estado
        } else {
            // Restaurar estado original
            if (quickFiltersHeader) {
                quickFiltersHeader.classList.remove('filters-active');
                quickFiltersHeader.title = 'Click para mostrar filtros r√°pidos';
            }
            
            if (searchContainer) {
                searchContainer.classList.remove('filters-active');
            }
            
            // Sin toast
        }
    }
    
    // Actualizar contador de filtros activos
    function updateActiveFiltersCounter(count) {
        let counterElement = document.querySelector('.active-filters-counter');
        
        // Crear el contador si no existe
        if (!counterElement) {
            counterElement = document.createElement('div');
            counterElement.className = 'active-filters-counter';
            counterElement.innerHTML = `
                <span class="counter-number">0</span>
                <span class="counter-label">filtros activos</span>
            `;
            
            // Insertar despu√©s del t√≠tulo en el header
            const headerTitle = document.querySelector('.quick-filters-header span');
            if (headerTitle) {
                headerTitle.parentNode.insertBefore(counterElement, headerTitle.nextSibling);
            }
        }
        
        // Actualizar el contador
        const counterNumber = counterElement.querySelector('.counter-number');
        if (counterNumber) {
            counterNumber.textContent = count;
        }
        
        // Mostrar/ocultar seg√∫n el conteo
        if (count > 0) {
            counterElement.style.display = 'flex';
        } else {
            counterElement.style.display = 'none';
        }
    }
    
    // Realizar b√∫squeda r√°pida optimizada
    function performQuickSearch(query, categories, filters) {
        const searchKey = generateSearchKey(query, categories, filters);
        console.log('üîç Ejecutando b√∫squeda r√°pida optimizada:', { query, categories, filters, searchKey });
        
        // Cancelar b√∫squeda anterior si existe
        if (searchRequestController) {
            searchRequestController.abort();
        }
        
        // Verificar cach√© primero
        const cachedResult = getFromCache(searchKey);
        if (cachedResult) {
            console.log('‚ö° Resultado encontrado en cach√©');
            filterPerformanceMetrics.cacheHits++;
            displayAdvancedResults(cachedResult.results, cachedResult.categories, cachedResult.query);
            
            // Mensaje espec√≠fico para cach√© con filtros
            const isFilterOnly = !query || !query.trim();
            const cacheMessage = isFilterOnly 
                ? `${cachedResult.total_results} resultados filtrados (cach√©)`
                : `${cachedResult.total_results} resultados (cach√©)`;
            showToast(cacheMessage, 'success');
            return;
        }
        
        // Debouncing para evitar b√∫squedas excesivas
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
        }
        
        searchDebounceTimer = setTimeout(() => {
            executeQuickSearch(query, categories, filters, searchKey);
        }, SEARCH_CONFIG.debounceDelay);
    }
    
    // Ejecutar b√∫squeda real
    function executeQuickSearch(query, categories, filters, searchKey, retryCount = 0) {
        const startTime = performance.now();
        showLoadingState();
        
        // Crear nuevo controller para esta b√∫squeda
        searchRequestController = new AbortController();
        
        // Construir URL - Los filtros r√°pidos funcionan sin query
        const params = new URLSearchParams();
        
        // Solo agregar query si no est√° vac√≠o
        if (query && query.trim()) {
            params.append('q', query.trim());
        }
        
        // Siempre agregar categor√≠as (requerido para filtros r√°pidos)
        categories.forEach(cat => params.append('categories', cat));
        
        // Agregar filtros espec√≠ficos
        Object.keys(filters).forEach(key => {
            if (filters[key] !== null && filters[key] !== undefined && filters[key] !== '') {
                params.append(key, filters[key]);
            }
        });
        
        // Indicar que es una b√∫squeda por filtros r√°pidos si no hay query
        if (!query || !query.trim()) {
            params.append('filter_only', 'true');
        }
        
        const url = `/api/search/advanced?${params.toString()}`;
        console.log('üîó URL construida:', url);
        
        fetch(url, { 
            signal: searchRequestController.signal,
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                // Actualizar m√©tricas de rendimiento
                updatePerformanceMetrics(responseTime);
                
                hideLoadingState();
                
                if (data.success) {
                    // Guardar en cach√©
                    saveToCache(searchKey, {
                        results: data.results,
                        categories: data.categories,
                        query: data.query,
                        total_results: data.total_results,
                        timestamp: Date.now()
                    });
                    
                    displayAdvancedResults(data.results, data.categories, data.query);
                    
                    // Mensaje discreto solo si no hay resultados
                    if (!data.total_results || data.total_results === 0) {
                        showToast('Sin resultados con los filtros aplicados', 'warning');
                    }
                } else {
                    showToast(data.error || 'Error en b√∫squeda r√°pida', 'error');
                }
            })
            .catch(error => {
                hideLoadingState();
                
                if (error.name === 'AbortError') {
                    console.log('üö´ B√∫squeda cancelada');
                    return;
                }
                
                console.error('‚ùå Error en b√∫squeda r√°pida:', error);
                
                // Reintentar si no se ha alcanzado el l√≠mite
                if (retryCount < SEARCH_CONFIG.maxRetries) {
                    console.log(`üîÑ Reintentando b√∫squeda (${retryCount + 1}/${SEARCH_CONFIG.maxRetries})`);
                    setTimeout(() => {
                        executeQuickSearch(query, categories, filters, searchKey, retryCount + 1);
                    }, SEARCH_CONFIG.retryDelay * (retryCount + 1));
                } else {
                    showToast('Error al realizar la b√∫squeda. Intenta nuevamente.', 'error');
                }
            });
    }
    
    // Obtener regi√≥n del usuario
    function getUserRegion() {
        // Intentar obtener desde localStorage o perfil
        const userInfo = UserStorage?.getBasicInfo();
        return userInfo?.region || 'Tlaxcala'; // Fallback por defecto
    }
    
    // Simular UserStorage si no existe
    if (typeof UserStorage === 'undefined') {
        window.UserStorage = {
            getBasicInfo: function() {
                return { region: 'Tlaxcala' };
            }
        };
    }
    
    // Actualizar texto de ayuda
    function updateHelpText(text) {
        console.log('üí° Actualizando texto de ayuda:', text);
        
        // Crear elemento de ayuda si no existe
        let helpText = document.getElementById('helpText');
        if (!helpText) {
            helpText = document.createElement('div');
            helpText.id = 'helpText';
            helpText.style.cssText = `
                text-align: center;
                padding: 20px;
                color: #6b7280;
                font-style: italic;
                background: #f9fafb;
                border-radius: 8px;
                margin: 20px 0;
                font-family: Arial, sans-serif;
            `;
            
            // Insertar despu√©s del contenedor de b√∫squeda
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) {
                searchContainer.parentNode.insertBefore(helpText, searchContainer.nextSibling);
            }
        }
        
            helpText.textContent = text;
        helpText.style.display = 'block';
    }
    

    
    // ========================================
    // FUNCIONES AUXILIARES
    // ========================================
    
    // Mostrar toast de notificaci√≥n (versi√≥n minimalista)
    function showToast(message, type = 'info') {
        // Limitar tipos que se muestran para reducir ruido
        const allowed = ['error', 'warning'];
        if (!allowed.includes(type)) return;
        
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `position: fixed; bottom: 20px; right: 20px; z-index: 10000;`;
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.style.cssText = `
            background: ${type === 'error' ? '#ef4444' : '#f59e0b'};
            color: white; padding: 10px 14px; border-radius: 8px; margin-top: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,.2); font-size: .9rem;
        `;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 2800);
    }
    
    // Mostrar estado de carga (barra discreta en resultados)
    function showLoadingState() {
        let resultsContainer = document.getElementById('searchResults');
        if (!resultsContainer) {
            // Crear contenedor de resultados si no existe a√∫n
            resultsContainer = document.createElement('div');
            resultsContainer.id = 'searchResults';
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && searchContainer.parentNode) {
                searchContainer.parentNode.insertBefore(resultsContainer, searchContainer.nextSibling);
            } else {
                document.body.appendChild(resultsContainer);
            }
        }

        let loadingBar = document.getElementById('loadingBar');
        if (!loadingBar) {
            loadingBar = document.createElement('div');
            loadingBar.id = 'loadingBar';
            loadingBar.className = 'loading-bar';
            loadingBar.innerHTML = `
                <div class="spinner"></div>
                <span>Buscando...</span>
                <div class="progress"></div>
            `;
            resultsContainer.prepend(loadingBar);
        }
        loadingBar.style.display = 'flex';
    }

    // Ocultar estado de carga (barra discreta)
    function hideLoadingState() {
        const loadingBar = document.getElementById('loadingBar');
        if (loadingBar) {
            loadingBar.remove();
        }
    }
    
    // ========================================
    // FUNCIONES DE OPTIMIZACI√ìN Y CACH√â
    // ========================================
    
    // Generar clave √∫nica para b√∫squeda
    function generateSearchKey(query, categories, filters) {
        const keyData = {
            query: query || '',
            categories: categories.sort(),
            filters: Object.keys(filters).sort().reduce((obj, key) => {
                obj[key] = filters[key];
                return obj;
            }, {})
        };
        return btoa(JSON.stringify(keyData)).replace(/[+/=]/g, '');
    }
    
    // Obtener resultado del cach√©
    function getFromCache(searchKey) {
        if (!searchCache.has(searchKey)) {
            return null;
        }
        
        const cached = searchCache.get(searchKey);
        const now = Date.now();
        
        // Verificar si el resultado ha expirado
        if (now - cached.timestamp > SEARCH_CONFIG.cacheExpiration) {
            searchCache.delete(searchKey);
            return null;
        }
        
        return cached;
    }
    
    // Guardar resultado en cach√©
    function saveToCache(searchKey, data) {
        // Limpiar cach√© si est√° lleno
        if (searchCache.size >= SEARCH_CONFIG.cacheMaxSize) {
            const firstKey = searchCache.keys().next().value;
            searchCache.delete(firstKey);
        }
        
        searchCache.set(searchKey, {
            ...data,
            timestamp: Date.now()
        });
        
        console.log(`üíæ Resultado guardado en cach√©. Tama√±o actual: ${searchCache.size}`);
    }
    
    // Actualizar m√©tricas de rendimiento
    function updatePerformanceMetrics(responseTime) {
        filterPerformanceMetrics.searches++;
        filterPerformanceMetrics.totalResponseTime += responseTime;
        filterPerformanceMetrics.averageResponseTime = 
            filterPerformanceMetrics.totalResponseTime / filterPerformanceMetrics.searches;
        
        // Log m√©tricas cada 10 b√∫squedas
        if (filterPerformanceMetrics.searches % 10 === 0) {
            console.log('üìä M√©tricas de rendimiento:', {
                totalSearches: filterPerformanceMetrics.searches,
                cacheHitRate: `${((filterPerformanceMetrics.cacheHits / filterPerformanceMetrics.searches) * 100).toFixed(1)}%`,
                avgResponseTime: `${filterPerformanceMetrics.averageResponseTime.toFixed(0)}ms`,
                cacheSize: searchCache.size
            });
        }
    }
    
    // Limpiar cach√© expirado
    function cleanExpiredCache() {
        const now = Date.now();
        const keysToDelete = [];
        
        for (const [key, value] of searchCache.entries()) {
            if (now - value.timestamp > SEARCH_CONFIG.cacheExpiration) {
                keysToDelete.push(key);
            }
        }
        
        keysToDelete.forEach(key => searchCache.delete(key));
        
        if (keysToDelete.length > 0) {
            console.log(`üßπ Limpieza de cach√©: ${keysToDelete.length} entradas eliminadas`);
        }
    }
    
    // Obtener estad√≠sticas de rendimiento
    function getPerformanceStats() {
        return {
            ...filterPerformanceMetrics,
            cacheHitRate: filterPerformanceMetrics.searches > 0 
                ? ((filterPerformanceMetrics.cacheHits / filterPerformanceMetrics.searches) * 100).toFixed(1) + '%'
                : '0%',
            cacheSize: searchCache.size,
            cacheMaxSize: SEARCH_CONFIG.cacheMaxSize
        };
    }
    
    // Mostrar resultados de b√∫squeda avanzada
    function displayAdvancedResults(results, categories, query) {
        console.log('üìä Mostrando resultados:', { results, categories, query });
        
        // Crear contenedor de resultados si no existe
        let resultsContainer = document.getElementById('searchResults');
        if (!resultsContainer) {
            resultsContainer = document.createElement('div');
            resultsContainer.id = 'searchResults';
            resultsContainer.style.cssText = `
                margin-top: 20px;
                padding: 20px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                font-family: Arial, sans-serif;
            `;
            
            // Insertar despu√©s del contenedor de b√∫squeda
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) {
                searchContainer.parentNode.insertBefore(resultsContainer, searchContainer.nextSibling);
            }
        }
        
        // Mostrar resultados
        if (results && results.length > 0) {
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 10px;">
                        üìä Resultados de b√∫squeda
                    </h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">
                        Se encontraron ${results.length} resultados
                        ${categories.length > 0 ? `en las categor√≠as: ${categories.join(', ')}` : ''}
                    </p>
                </div>
                <div style="display: grid; gap: 15px;">
            `;
            
            results.forEach((result, index) => {
                html += `
                    <div style="
                        padding: 15px;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        background: #f9fafb;
                    ">
                        <h4 style="color: #374151; margin-bottom: 8px;">
                            ${result.title || result.nombre || `Resultado ${index + 1}`}
                        </h4>
                        <p style="color: #6b7280; margin-bottom: 8px;">
                            ${result.description || result.descripcion || 'Sin descripci√≥n disponible'}
                        </p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${result.category ? `<span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${result.category}</span>` : ''}
                            ${result.type ? `<span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${result.type}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üîç</div>
                    <h3 style="color: #374151; margin-bottom: 10px;">No se encontraron resultados</h3>
                    <p style="color: #6b7280;">Intenta con otros filtros o t√©rminos de b√∫squeda</p>
                </div>
            `;
            resultsContainer.style.display = 'block';
        }
    }
    
    // Inicializar optimizaciones
    function initializeOptimizations() {
        console.log('‚ö° Inicializando optimizaciones de rendimiento');
        
        // Limpiar cach√© expirado cada 5 minutos
        setInterval(cleanExpiredCache, 5 * 60 * 1000);
        
        // A√±adir listener para visibilidad de la p√°gina
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                // Cancelar b√∫squedas pendientes cuando la p√°gina se oculta
                if (searchRequestController) {
                    searchRequestController.abort();
                }
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
            }
        });
        
        // A√±adir funci√≥n global para depuraci√≥n
        window.getFilterStats = getPerformanceStats;
        window.clearFilterCache = () => {
            searchCache.clear();
            console.log('üßπ Cach√© de filtros limpiado manualmente');
        };
        
        // Precargar datos comunes si es necesario
        preloadCommonData();
        
        console.log('‚ö° Optimizaciones inicializadas');
    }
    
    // Precargar datos comunes (funci√≥n simplificada)
    function preloadCommonData() {
        console.log('üîÑ Precarga de datos comunes (simplificado)');
        // Esta funci√≥n se simplific√≥ para evitar dependencias
    }
    
    // Resetear todos los filtros
    function resetAllFilters() {
        console.log('üßπ Reseteando todos los filtros');
        
        // Limpiar chips activos
        document.querySelectorAll('.quick-filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        
        // Limpiar formulario de b√∫squeda
        const searchInput = document.getElementById('globalSearchInput');
        if (searchInput) searchInput.value = '';
        
        // Ocultar resultados
        const searchResults = document.getElementById('searchResults');
        if (searchResults) {
            searchResults.style.display = 'none';
        }
        
        // Limpiar filtros avanzados (funci√≥n simplificada)
        function clearAllAdvancedFilters() {
            console.log('üßπ Limpiando filtros avanzados');
            // Esta funci√≥n se simplific√≥ ya que no hay filtros avanzados
        }
        
        // Restaurar texto de ayuda
        updateHelpText('Usa los filtros r√°pidos arriba o personaliza tu b√∫squeda abajo');
        
        // Restaurar estado visual
        updateFilterActiveState(false);
        
        // Resetear contador de filtros activos
        updateActiveFiltersCounter(0);
        
        showToast('Filtros reseteados', 'info');
    }
    
    // Inicializar tutorial
    function initializeTutorial() {
        const tutorialClose = document.getElementById('tutorialClose');
        const tutorialOverlay = document.getElementById('tutorialOverlay');
        const tutorialPrev = document.getElementById('tutorialPrev');
        const tutorialNext = document.getElementById('tutorialNext');
        const tutorialFinish = document.getElementById('tutorialFinish');
        
        if (tutorialClose) {
            tutorialClose.addEventListener('click', closeTutorial);
        }
        
        if (tutorialOverlay) {
            tutorialOverlay.addEventListener('click', closeTutorial);
        }
        
        if (tutorialPrev) {
            tutorialPrev.addEventListener('click', () => changeTutorialStep(-1));
        }
        
        if (tutorialNext) {
            tutorialNext.addEventListener('click', () => changeTutorialStep(1));
        }
        
        if (tutorialFinish) {
            tutorialFinish.addEventListener('click', closeTutorial);
        }
    }
    
    // Mostrar tutorial
    function showTutorial() {
        console.log('üìö Mostrando tutorial');
        
        if (tutorialModal) {
            tutorialModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            currentTutorialStep = 1;
            updateTutorialStep();
        }
    }
    
    // Cerrar tutorial
    function closeTutorial() {
        console.log('üìö Cerrando tutorial');
        
        if (tutorialModal) {
            tutorialModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Cambiar paso del tutorial
    function changeTutorialStep(direction) {
        const newStep = currentTutorialStep + direction;
        const totalSteps = 4;
        
        if (newStep >= 1 && newStep <= totalSteps) {
            currentTutorialStep = newStep;
            updateTutorialStep();
        }
    }
    
    // Actualizar paso del tutorial
    function updateTutorialStep() {
        const totalSteps = 4;
        
        // Ocultar todos los pasos
        document.querySelectorAll('.tutorial-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Mostrar paso actual
        const currentStepElement = document.querySelector(`[data-step="${currentTutorialStep}"]`);
        if (currentStepElement) {
            currentStepElement.classList.add('active');
        }
        
        // Actualizar controles
        const prevBtn = document.getElementById('tutorialPrev');
        const nextBtn = document.getElementById('tutorialNext');
        const finishBtn = document.getElementById('tutorialFinish');
        const currentStepSpan = document.getElementById('currentStep');
        const progressFill = document.getElementById('tutorialProgress');
        
        if (prevBtn) {
            prevBtn.disabled = currentTutorialStep === 1;
        }
        
        if (nextBtn && finishBtn) {
            if (currentTutorialStep === totalSteps) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                finishBtn.style.display = 'none';
            }
        }
        
        if (currentStepSpan) {
            currentStepSpan.textContent = currentTutorialStep;
        }
        
        if (progressFill) {
            const progress = (currentTutorialStep / totalSteps) * 100;
            progressFill.style.width = `${progress}%`;
        }
    }
    
    // Inicializar autocompletado (funci√≥n simplificada)
    function initializeAutocomplete() {
        console.log('üî§ Inicializando autocompletado (simplificado)');
        // Esta funci√≥n se simplific√≥ para evitar dependencias
    }
    
    // Mostrar sugerencias de equipamiento
    function showEquipamientoSuggestions(query) {
        const suggestions = [
            'microscopio', 'computadoras', 'centrifuga', 'espectrofot√≥metro',
            'autoclave', 'incubadora', 'balanza anal√≠tica', 'campana extractora',
            'pipetas', 'cristaler√≠a', 'reactivos', 'software especializado',
            'impresora 3D', 'osciloscopio', 'mult√≠metro', 'soldador'
        ];
        
        const filtered = suggestions.filter(item => 
            item.toLowerCase().includes(query)
        ).slice(0, 5);
        
        const suggestionsDiv = document.getElementById('equipamientoSuggestions');
        if (suggestionsDiv && filtered.length > 0) {
            suggestionsDiv.innerHTML = filtered.map(item => 
                `<div class="autocomplete-item" onclick="selectEquipamiento('${item}')">${item}</div>`
            ).join('');
            suggestionsDiv.style.display = 'block';
        }
    }
    
    // Ocultar sugerencias de equipamiento
    function hideEquipamientoSuggestions() {
        const suggestionsDiv = document.getElementById('equipamientoSuggestions');
        if (suggestionsDiv) {
            suggestionsDiv.style.display = 'none';
        }
    }
    
    // Seleccionar equipamiento
    function selectEquipamiento(item) {
        const equipamientoInput = document.getElementById('filterEquipamiento');
        if (equipamientoInput) {
            const currentValue = equipamientoInput.value;
            const words = currentValue.split(',').map(w => w.trim());
            words[words.length - 1] = item;
            equipamientoInput.value = words.join(', ');
            hideEquipamientoSuggestions();
        }
    }
    
    // Guardar filtros actuales
    function saveCurrentFilters() {
        const name = prompt('Nombre para estos filtros:');
        if (!name) return;
        
        const currentFilters = {
            id: Date.now(),
            name: name,
            query: searchInput?.value || '',
            categories: getSelectedCategories(),
            advancedFilters: isAdvancedMode ? collectAdvancedFilters() : {},
            timestamp: new Date().toISOString()
        };
        
        savedFilters.push(currentFilters);
        localStorage.setItem('savedFilters', JSON.stringify(savedFilters));
        
        loadSavedFilters();
        showToast(`Filtros guardados como "${name}"`, 'success');
    }
    
    // Obtener categor√≠as seleccionadas
    function getSelectedCategories() {
        if (isAdvancedMode) {
            const checkboxes = document.querySelectorAll('.filter-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        } else {
            const activeButtons = document.querySelectorAll('.filter-category-btn.active');
            return Array.from(activeButtons).map(btn => btn.getAttribute('data-category'));
        }
    }
    
    // Cargar filtros guardados
    function loadSavedFilters() {
        const content = document.getElementById('savedFiltersContent');
        if (!content) return;
        
        if (savedFilters.length === 0) {
            content.innerHTML = `
                <div class="no-saved-filters">
                    <i class="fas fa-bookmark"></i>
                    <p>No tienes filtros guardados a√∫n</p>
                    <small>Aplica filtros y gu√°rdalos para acceso r√°pido</small>
                </div>
            `;
        } else {
            content.innerHTML = savedFilters.map(filter => `
                <div class="saved-filter-item" data-filter-id="${filter.id}">
                    <div class="saved-filter-info">
                        <h4>${filter.name}</h4>
                        <p>${filter.categories.join(', ')}</p>
                        <small>${new Date(filter.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div class="saved-filter-actions">
                        <button onclick="applySavedFilter(${filter.id})" class="btn-apply-saved">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="deleteSavedFilter(${filter.id})" class="btn-delete-saved">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    }
    
    // Aplicar filtro guardado
    function applySavedFilter(filterId) {
        const filter = savedFilters.find(f => f.id === filterId);
        if (!filter) return;
        
        console.log('üìÇ Aplicando filtro guardado:', filter.name);
        
        // Aplicar filtros
        if (searchInput) searchInput.value = filter.query;
        
        if (Object.keys(filter.advancedFilters).length > 0) {
            // Modo avanzado
            showAdvancedPanel();
            // Aplicar filtros avanzados aqu√≠
            setTimeout(() => {
                applyAdvancedFilters();
            }, 100);
        } else {
            // Modo simple
            performQuickSearch(filter.query, filter.categories, {});
        }
        
        showToast(`Filtros "${filter.name}" aplicados`, 'success');
    }
    
    // Eliminar filtro guardado
    function deleteSavedFilter(filterId) {
        if (!confirm('¬øEliminar este filtro guardado?')) return;
        
        savedFilters = savedFilters.filter(f => f.id !== filterId);
        localStorage.setItem('savedFilters', JSON.stringify(savedFilters));
        loadSavedFilters();
        showToast('Filtro eliminado', 'info');
    }
    
    // Inicializar funcionalidades f√°ciles
    initializeEasyFeatures();
    
    // ========================================
    // MEJORAS IMPLEMENTADAS - FILTROS R√ÅPIDOS
    // ========================================
    /*
    ‚úÖ FUNCIONALIDADES IMPLEMENTADAS:
    
    üéØ FILTROS FUNCIONAN SIN QUERY:
    - Los botones de filtros r√°pidos funcionan independientemente de la barra de b√∫squeda
    - No es necesario escribir t√©rminos de b√∫squeda para usar los filtros
    - Los filtros se aplican usando solo categor√≠as y par√°metros espec√≠ficos
    
    üìÅ TOGGLE MEJORADO:
    - Bot√≥n de esconder/mostrar funciona correctamente
    - Animaciones suaves de entrada y salida
    - Estado visual persistente (header cambia de color)
    - Los filtros se ocultan autom√°ticamente despu√©s de aplicarlos
    
    üé® MEJORAS VISUALES:
    - Header cambia a verde cuando hay filtros activos
    - Header cambia a gris cuando los filtros est√°n ocultos
    - Animaciones de hover en el header
    - Contador de filtros activos
    - Indicadores visuales en chips activos
    
    üîß FUNCIONALIDADES MEJORADAS:
    - Click en chip activo lo desactiva
    - Limpieza autom√°tica de la barra de b√∫squeda
    - Mensajes informativos descriptivos
    - Estado visual persistente hasta resetear
    - Tooltips informativos en el header
    
    ‚ö° OPTIMIZACIONES:
    - Sistema de cach√© para resultados
    - Debouncing para evitar b√∫squedas excesivas
    - M√©tricas de rendimiento
    - Manejo robusto de errores
    */
    
    </script>

    <!-- Modal de Tutorial de Filtros -->
    <div class="tutorial-modal" id="tutorialModal" style="display: none;">
        <div class="tutorial-overlay" id="tutorialOverlay"></div>
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h2><i class="fas fa-graduation-cap"></i> Tutorial de Filtros</h2>
                <button class="tutorial-close" id="tutorialClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tutorial-body">
                <div class="tutorial-step active" data-step="1">
                    <div class="tutorial-step-content">
                        <div class="tutorial-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3>Filtros R√°pidos</h3>
                        <p>Usa los botones de "B√∫squedas R√°pidas" para encontrar r√°pidamente:</p>
                        <ul>
                            <li>üß™ Laboratorios disponibles</li>
                            <li>üìã Proyectos activos</li>
                            <li>üë• Investigadores nuevos</li>
                            <li>üìç Recursos en tu regi√≥n</li>
                        </ul>
                    </div>
                </div>
                <div class="tutorial-step" data-step="2">
                    <div class="tutorial-step-content">
                        <div class="tutorial-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>B√∫squeda Simple vs Avanzada</h3>
                        <p>Elige el modo que mejor se adapte a tus necesidades:</p>
                        <ul>
                            <li>üîµ <strong>Simple</strong>: Busca por categor√≠as b√°sicas</li>
                            <li>üü£ <strong>Avanzada</strong>: Filtros espec√≠ficos y detallados</li>
                        </ul>
                    </div>
                </div>
                <div class="tutorial-step" data-step="3">
                    <div class="tutorial-step-content">
                        <div class="tutorial-icon">
                            <i class="fas fa-bookmark"></i>
                        </div>
                        <h3>Guarda tus Filtros</h3>
                        <p>Cuando encuentres una combinaci√≥n √∫til de filtros:</p>
                        <ul>
                            <li>üíæ Gu√°rdalos para uso futuro</li>
                            <li>üîñ Accede r√°pidamente desde "Mis Filtros"</li>
                            <li>üè∑Ô∏è Ponles nombres descriptivos</li>
                        </ul>
                    </div>
                </div>
                <div class="tutorial-step" data-step="4">
                    <div class="tutorial-step-content">
                        <div class="tutorial-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <h3>Funciones Inteligentes</h3>
                        <p>Los filtros incluyen caracter√≠sticas avanzadas:</p>
                        <ul>
                            <li>üìù Autocompletado en campos de texto</li>
                            <li>üîÑ Municipios se actualizan seg√∫n estado</li>
                            <li>üìÖ Per√≠odos predefinidos para fechas</li>
                            <li>üí° Sugerencias en tiempo real</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="tutorial-footer">
                <div class="tutorial-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="tutorialProgress"></div>
                    </div>
                    <span class="progress-text">
                        <span id="currentStep">1</span> de <span id="totalSteps">4</span>
                    </span>
                </div>
                <div class="tutorial-actions">
                    <button class="tutorial-btn tutorial-prev" id="tutorialPrev" disabled>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button class="tutorial-btn tutorial-next" id="tutorialNext">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="tutorial-btn tutorial-finish" id="tutorialFinish" style="display: none;">
                        <i class="fas fa-check"></i> ¬°Entendido!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para manejo de localStorage del usuario -->
    <script src="{{ url_for('static', filename='js/user-storage.js') }}"></script>
    <script>
        // Ejemplo de uso del sistema localStorage
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† P√°gina home cargada');
            
            // Verificar si el usuario est√° logueado
            if (UserStorage.isLoggedIn()) {
                console.log('‚úÖ Usuario logueado detectado desde localStorage');
                
                // Obtener informaci√≥n b√°sica del usuario
                const userInfo = UserStorage.getBasicInfo();
                if (userInfo) {
                    console.log('üë§ Usuario:', userInfo.name);
                    console.log('üè∑Ô∏è Rol:', userInfo.role);
                    console.log('üìß Email:', userInfo.email);
                    console.log('üè¢ Instituci√≥n:', userInfo.institution);
                    console.log('üéØ √Årea:', userInfo.area);
                    
                    // Actualizar elementos de la p√°gina con datos del usuario
                    updateUserInterface(userInfo);
                }
                
                // Mostrar estad√≠sticas de sesi√≥n
                const stats = UserStorage.getStorageStats();
                console.log('üìä Estad√≠sticas de sesi√≥n:', stats);
                
                // Verificar si la sesi√≥n ha expirado (8 horas)
                if (UserStorage.isSessionExpired(480)) {
                    console.warn('‚ö†Ô∏è Sesi√≥n expirada');
                    // Aqu√≠ podr√≠as mostrar un modal o redirigir
                }
            } else {
                console.log('‚ùå Usuario no est√° logueado');
            }
        });
        
        function updateUserInterface(userInfo) {
            // Actualizar elementos de la p√°gina con informaci√≥n del usuario
            try {
                // Actualizar nombre del usuario en la interfaz
                const userNameElements = document.querySelectorAll('.user-name');
                userNameElements.forEach(element => {
                    element.textContent = userInfo.name;
                });
                
                // Actualizar rol del usuario
                const userRoleElements = document.querySelectorAll('.user-role');
                userRoleElements.forEach(element => {
                    element.textContent = userInfo.role;
                });
                
                // Actualizar avatar del usuario
                const userAvatarElements = document.querySelectorAll('.user-avatar');
                userAvatarElements.forEach(element => {
                    if (userInfo.avatar) {
                        element.src = userInfo.avatar;
                    }
                });
                
                // Mostrar elementos espec√≠ficos seg√∫n el rol
                if (userInfo.role === 'Super Administrador' || userInfo.role === 'Administrador') {
                    document.body.classList.add('admin-user');
                    const adminElements = document.querySelectorAll('.admin-only');
                    adminElements.forEach(element => {
                        element.style.display = 'block';
                    });
                }
                
                // Personalizar saludo seg√∫n la hora
                const greeting = getGreeting();
                const greetingElements = document.querySelectorAll('.user-greeting');
                greetingElements.forEach(element => {
                    element.textContent = `${greeting}, ${userInfo.name.split(' ')[0]}`;
                });
                
                console.log('‚úÖ Interfaz actualizada con datos del usuario');
                
            } catch (error) {
                console.error('‚ùå Error actualizando interfaz:', error);
            }
        }
        
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Buenos d√≠as';
            if (hour < 18) return 'Buenas tardes';
            return 'Buenas noches';
        }
        
        // Escuchar eventos del sistema de localStorage
        window.addEventListener('userLoggedIn', function(e) {
            console.log('üéâ Usuario logueado:', e.detail);
            // Recargar p√°gina o actualizar interfaz
        });
        
        window.addEventListener('userLoggedOut', function(e) {
            console.log('üëã Usuario deslogueado:', e.detail);
            // Limpiar interfaz
            document.body.classList.remove('admin-user');
        });
        
        window.addEventListener('userDataUpdated', function(e) {
            console.log('üîÑ Datos actualizados:', e.detail.key, '=', e.detail.value);
            // Actualizar interfaz seg√∫n el dato modificado
        });
        
        // Funci√≥n para mostrar informaci√≥n del usuario en consola (para debugging)
        window.showUserInfo = function() {
            console.log('üìã INFORMACI√ìN DEL USUARIO:');
            console.log('¬øLogueado?', UserStorage.isLoggedIn());
            console.log('Datos completos:', UserStorage.get());
            console.log('Info b√°sica:', UserStorage.getBasicInfo());
            console.log('Estad√≠sticas:', UserStorage.getStorageStats());
            console.table(UserStorage.getStorageStats());
        };
        
        // Funci√≥n para limpiar datos del usuario (para debugging)
        window.clearUserData = function() {
            UserStorage.clearAll();
            console.log('üßπ Datos del usuario eliminados');
        };
        
        console.log('‚úÖ Sistema localStorage inicializado en home.html');
        console.log('üí° Usa showUserInfo() para ver informaci√≥n del usuario');
        console.log('üí° Usa clearUserData() para limpiar datos de prueba');
    </script>

    <!-- JavaScript para estad√≠sticas mejoradas -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar estad√≠sticas mejoradas
        initEnhancedStats();
        
        // Agregar efectos de sonido y feedback visual
        addStatCardInteractions();
        
        // Cargar datos de estad√≠sticas din√°micamente
        loadDynamicStats();
    });

    function initEnhancedStats() {
        const statCards = document.querySelectorAll('.stat-card-enhanced');
        
        // Agregar efectos de entrada escalonados
        statCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            
            // Observar cuando entran en viewport
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('in-view');
                        animateNumber(entry.target.querySelector('.stat-number-enhanced'));
                    }
                });
            }, { threshold: 0.3 });
            
            observer.observe(card);
        });
    }

    function addStatCardInteractions() {
        const statCards = document.querySelectorAll('.stat-card-enhanced');
        
        statCards.forEach(card => {
            // Efecto de click
            card.addEventListener('click', function(e) {
                // Crear efecto de ripple
                createRippleEffect(e, this);
                
                // Feedback visual
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
            
            // Efecto de hover mejorado
            card.addEventListener('mouseenter', function() {
                this.querySelector('.stat-trend').style.transform = 'scale(1.2) rotate(360deg)';
                this.querySelector('.stat-icon-enhanced').style.transform = 'scale(1.1) rotate(5deg)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.querySelector('.stat-trend').style.transform = '';
                this.querySelector('.stat-icon-enhanced').style.transform = '';
            });
            
            // Accesibilidad mejorada
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    }

    function createRippleEffect(event, element) {
        const ripple = document.createElement('div');
        const rect = element.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
            left: ${x}px;
            top: ${y}px;
            width: ${size}px;
            height: ${size}px;
            pointer-events: none;
            z-index: 1000;
        `;
        
        element.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }

    function animateNumber(element) {
        if (!element || element.hasAttribute('data-animated')) return;
        
        const finalNumber = parseInt(element.textContent);
        const duration = 1500;
        const steps = 60;
        const stepValue = finalNumber / steps;
        let currentNumber = 0;
        
        element.setAttribute('data-animated', 'true');
        
        const timer = setInterval(() => {
            currentNumber += stepValue;
            if (currentNumber >= finalNumber) {
                currentNumber = finalNumber;
                clearInterval(timer);
            }
            element.textContent = Math.floor(currentNumber);
        }, duration / steps);
    }

    function loadDynamicStats() {
        // Simular carga de estad√≠sticas actualizadas
        const statCards = document.querySelectorAll('.stat-card-enhanced');
        
        // Agregar indicador de "datos en tiempo real"
        statCards.forEach(card => {
            const trend = card.querySelector('.stat-trend');
            if (trend) {
                trend.title = 'Datos actualizados en tiempo real';
                
                // Agregar pulso sutil para indicar datos en vivo
                setInterval(() => {
                    trend.style.opacity = '0.5';
                    setTimeout(() => {
                        trend.style.opacity = '1';
                    }, 500);
                }, 5000);
            }
        });
    }

    // CSS para el efecto ripple
    const rippleStyles = document.createElement('style');
    rippleStyles.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .stat-card-enhanced.in-view {
            animation: statCardSlideIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .stat-card-enhanced:active {
            transform: scale(0.98) !important;
        }
        
        .stat-number-enhanced {
            transition: all 0.3s ease;
        }
        
        .stat-card-enhanced:hover .stat-number-enhanced {
            color: #111827;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    `;
    document.head.appendChild(rippleStyles);

    // Funci√≥n para actualizar estad√≠sticas (puede ser llamada desde otros scripts)
    window.updateStats = function(newStats) {
        Object.keys(newStats).forEach(key => {
            const element = document.querySelector(`[data-category="${key}"] .stat-number-enhanced`);
            if (element) {
                const currentValue = parseInt(element.textContent);
                const newValue = newStats[key];
                
                if (currentValue !== newValue) {
                    // Animar el cambio
                    element.style.transform = 'scale(1.2)';
                    element.style.color = '#10b981';
                    
                    setTimeout(() => {
                        element.textContent = newValue;
                        element.style.transform = '';
                        element.style.color = '';
                    }, 300);
                }
            }
        });
    };

    // Tooltip mejorado para las cards
    window.addEventListener('load', function() {
        const tooltips = {
            'laboratorios': 'Haz clic para explorar laboratorios disponibles',
            'proyectos': 'Descubre proyectos de investigaci√≥n activos',
            'investigadores': 'Conecta con expertos en diferentes √°reas',
            'instituciones': 'Explora centros acad√©micos y de investigaci√≥n'
        };
        
        document.querySelectorAll('.stat-card-enhanced').forEach(card => {
            const category = card.getAttribute('data-category');
            if (tooltips[category]) {
                card.setAttribute('title', tooltips[category]);
                card.setAttribute('aria-label', tooltips[category]);
            }
        });
    });
    </script>
{% endblock %}
