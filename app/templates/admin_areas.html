{% extends 'base_admin.html' %}
{% block title %}Administrar √Åreas{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='improved-styles.css') }}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="floating-icons-container">
    <div class="floating-icon icon1">üìö</div>
    <div class="floating-icon icon2">üíª</div>
    <div class="floating-icon icon3">üéì</div>
    <div class="floating-icon icon4">‚úèÔ∏è</div>
    <div class="floating-icon icon5">üìê</div>
    <div class="floating-icon icon6">üî¨</div>
    <div class="floating-icon icon7">üé®</div>
    <div class="floating-icon icon8">üìù</div>
    <div class="floating-icon icon9">üîç</div>
    <div class="floating-icon icon10">üìä</div>
    <div class="floating-icon icon11">üí°</div>
    <div class="floating-icon icon12">‚öóÔ∏è</div>
    <div class="floating-icon icon13">üìì</div>
    <div class="floating-icon icon14">üßÆ</div>
    <div class="floating-icon icon15">üì±</div>
    <div class="floating-icon icon16">üéØ</div>
    <div class="floating-icon icon17">üìñ</div>
    <div class="floating-icon icon18">üîñ</div>
    <div class="floating-icon icon19">üìè</div>
    <div class="floating-icon icon20">üé≠</div>
</div>

<div class="content">
    <h2> Administrar √Åreas</h2>
    <br>
    <div class="admin-areas-container">
        <!-- Contenedor Principal Izquierdo -->
        <div class="izquierda">
            <!-- Primera fila izquierda -->
            <div class="table-responsive">
                <table class="table table-striped" >
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th class="nombre-area-col">Nombre del √Årea</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in areas %}
                        <tr>
                            <td>{{ area.id_area }}</td>
                            <td class="nombre-area-col">{{ area.nombre_area }}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm" onclick="editArea({{ area.id_area }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteArea({{ area.id_area }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <br>
            <!-- Segunda fila izquierda -->
            <div class="card">
                <div class="card-header">
                    <h2>Estad√≠sticas</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5>Total √Åreas</h5>
                                    <h3>{{ areas|length }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor Principal Derecho -->
        <div class="derecha">
            <!-- Primera fila derecha -->
            <div class="card">
                <div class="card-header">
                    <h2>Datos del √Årea</h2>
                </div>
                <div class="card-body">
                    <form id="areaForm">
                        <input type="hidden" id="area_id" name="area_id">
                        <div class="mb-3">
                            <label for="nombre_area" class="form-label">Nombre del √Årea</label>
                            <input type="text" class="form-control" id="nombre_area" name="nombre_area" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="saveArea()">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Limpiar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <br>
            <br>
            <!-- Segunda fila derecha -->
            <div class="card">
                <div class="card-header">
                    <h2>Detalles del √Årea</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div id="areaDetails">
                                <div class="alert alert-info" id="noAreaSelected">
                                    <i class="fas fa-info-circle"></i> Seleccione un √°rea para ver sus detalles
                                </div>
                                <div id="areaInfo" style="display: none;" class="area-details-container">
                                    <div class="area-header">
                                        <h3 class="area-title">
                                            <i class="fas fa-building"></i> <span id="areaName" class="area-name"></span>
                                        </h3>
                                    </div>
                                    <hr class="area-divider">
                                    <div class="row area-info-grid">
                                        <div class="col-md-6 info-card">
                                            <div class="info-item">
                                                <i class="fas fa-hashtag info-icon"></i> <div class="info-content">
                                                    <label>ID del √Årea</label>
                                                    <span id="areaId" class="info-value"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 info-card">
                                            <div class="info-item">
                                                <i class="fas fa-user info-icon"></i> <div class="info-content">
                                                    <label>Creado por</label>
                                                    <span id="areaCreatedBy" class="info-value"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 info-card">
                                            <div class="info-item">
                                                <i class="fas fa-calendar-plus info-icon"></i> <div class="info-content">
                                                    <label>Fecha de creaci√≥n</label>
                                                    <span id="areaCreationDate" class="info-value"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 info-card">
                                            <div class="info-item">
                                                <i class="fas fa-calendar-check info-icon"></i> <div class="info-content">
                                                    <label>√öltima modificaci√≥n</label>
                                                    <span id="areaLastModified" class="info-value"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 info-card">
                                            <div class="info-item">
                                                <i class="fas fa-user-edit info-icon"></i> <div class="info-content">
                                                    <label>Modificado por</label>
                                                    <span id="areaModifiedBy" class="info-value"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function resetForm() {
    document.getElementById('areaForm').reset();
    document.getElementById('area_id').value = '';
}

function editArea(id) {
    // Mostrar detalles del √°rea
    document.getElementById('noAreaSelected').style.display = 'none';
    document.getElementById('areaInfo').style.display = 'block';

    // Limpiar el formulario
    document.getElementById('areaForm').reset();
    document.getElementById('area_id').value = id;

    // Obtener los detalles completos del √°rea
    fetch(`/admin/areas/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('nombre_area').value = data.nombre_area || '';
            document.getElementById('areaId').textContent = data.id_area || '';
            document.getElementById('areaName').textContent = data.nombre_area || '';
            document.getElementById('areaCreatedBy').textContent = data.creado_por || '';
            document.getElementById('areaModifiedBy').textContent = data.modificado_por || '';
            if (data.fecha_creacion) {
                const fecha = new Date(data.fecha_creacion);
                document.getElementById('areaCreationDate').textContent = fecha.toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else {
                document.getElementById('areaCreationDate').textContent = '';
            }
            if (data.ultima_modificacion) {
                const mod = new Date(data.ultima_modificacion);
                document.getElementById('areaLastModified').textContent = mod.toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else {
                document.getElementById('areaLastModified').textContent = '';
            }
        })
        .catch(error => {
            console.error('Error al obtener detalles del √°rea:', error);
            document.getElementById('areaCreationDate').textContent = 'No disponible';
            document.getElementById('areaLastModified').textContent = 'No disponible';
        });
}

function deleteArea(id) {
    Swal.fire({
        title: '¬øEst√° seguro?',
        text: "Esta acci√≥n no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/admin/areas/eliminar/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.mensaje) {
                    Swal.fire({
                        icon: 'success',
                        title: '¬°√âxito!',
                        text: data.mensaje
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al eliminar el √°rea'
                });
            });
        }
    });
}

function saveArea() {
    const form = document.getElementById('areaForm');
    const formData = new FormData(form);
    const area_id = formData.get('area_id');
    
    let url = '/admin/areas/agregar';
    let method = 'POST';
    let body = formData;
    
    if (area_id) {
        url = `/admin/areas/editar/${area_id}`;
        method = 'PUT';
        let jsonData = {};
        formData.forEach((value, key) => { jsonData[key] = value; });
        body = JSON.stringify(jsonData);
    }
    
    fetch(url, {
        method: method,
        body: body,
        headers: area_id ? { 'Content-Type': 'application/json' } : undefined
    })
    .then(response => response.json())
    .then(data => {
        if (data.mensaje) {
            Swal.fire({
                icon: 'success',
                title: '¬°√âxito!',
                text: data.mensaje
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al guardar el √°rea'
        });
    });
}
</script>
{% endblock %}
