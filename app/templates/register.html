{% extends "base-simple.html" %}

{% block title %}Registro{% endblock %}

{% block extra_head %}
    <!-- Estilos de Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<!-- Iconos flotantes de fondo -->
<div class="floating-icons-container">
    {% for i, icon in [
        (1,'📚'),(2,'💻'),(3,'🎓'),(4,'✏️'),(5,'📐'),(6,'🔬'),(7,'🎨'),(8,'📝'),(9,'🔍'),(10,'📊'),
        (11,'💡'),(12,'⚗️'),(13,'📓'),(14,'🧮'),(15,'📱'),(16,'🎯'),(17,'📖'),(18,'🔖'),(19,'📏'),(20,'🎭')]
    %}
        <div class="floating-icon icon{{i}}">{{ icon }}</div>
    {% endfor %}
</div>

<!-- Contenedor principal -->
<div class="register-container d-flex justify-content-center align-items-center">
    <div class="register-form-container register-card">
        <!-- Encabezado -->
        <div class="login-form-header register-header">
            <div class="login-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <h2 class="login-title">Crear cuenta</h2>
            <p class="login-subtitle">Completa los campos para registrarte en el portal</p>
            
            <!-- Indicador de progreso -->
            <div class="form-progress">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">0% completado</div>
            </div>
        </div>

        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages mb-3">
                {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <div class="flash-icon"><i class="fas fa-info-circle"></i></div>
                            <div class="flash-content"><span>{{ message }}</span></div>
                            <button type="button" class="flash-close" onclick="closeFlashMessage(this)"><i class="fas fa-times"></i></button>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Formulario de registro -->
        <form action="{{ url_for('register.register') }}" method="POST" class="login-form" id="registerForm">
            <!-- Fila 1 -->
            <div class="form-row">
                <div class="form-group">
                    <label for="nombre" class="form-label"><i class="fas fa-user"></i><span> Nombre</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="nombre" name="nombre" class="form-control" placeholder="Ingresa tu nombre" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="apellido_paterno" class="form-label"><i class="fas fa-user"></i><span> Apellido paterno</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="apellido_paterno" name="apellido_paterno" class="form-control" placeholder="Ingresa tu apellido paterno" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="apellido_materno" class="form-label"><i class="fas fa-user"></i><span> Apellido materno</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="apellido_materno" name="apellido_materno" class="form-control" placeholder="Ingresa tu apellido materno" required>
                    </div>
                </div>
            </div>

            <!-- Fila 2 -->
            <div class="form-row">
                <div class="form-group">
                    <label for="username" class="form-label"><i class="fas fa-user"></i><span> Usuario</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="username" name="username" class="form-control" placeholder="Ingresa tu nombre de usuario" required>
                    </div>
                </div>

                <div class="form-group" id="group_matricula" style="display:none">
                    <label for="matricula" class="form-label"><i class="fas fa-id-card"></i><span id="label_matricula"> Matrícula</span></label>
                    <div class="input-wrapper">
                        <input type="text" id="matricula" name="matricula" class="form-control" placeholder="Ingresa tu matrícula">
                    </div>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label"><i class="fas fa-envelope"></i><span> Email</span></label>
                    <div class="input-wrapper">
                        <input type="email" id="email" name="email" class="form-control" placeholder="Ingresa tu email" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="telefono" class="form-label"><i class="fas fa-phone"></i><span> Teléfono</span></label>
                    <div class="input-wrapper">
                        <input type="tel" id="telefono" name="telefono" class="form-control" placeholder="Ingresa tu teléfono" required>
                    </div>
                </div>
            </div>

            <!-- Tipo de usuario -->
            <div class="form-row">
                <div class="form-group" style="flex:1 1 100%">
                    <label class="form-label"><i class="fas fa-users-cog"></i><span> Tipo de usuario</span></label>
                    <div class="input-wrapper">
                        <select id="user_type" name="user_type" class="form-control" required>
                            <option value="">Selecciona un tipo de usuario</option>
                            <option value="normal" selected>Usuario (sin afiliación)</option>
                            <option value="estudiante">Estudiante</option>
                            <option value="docente">Docente</option>
                            <option value="investigador">Investigador</option>
                            <option value="administrativo">Usuario administrativo (requiere aprobación)</option>
                            <option value="admin_laboratorio">Administrador de laboratorio (requiere aprobación)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Fila 3 Selecciones -->
            <div class="form-row">
                <div class="form-group" id="group_area" style="display:none">
                    <label for="id_area" class="form-label"><i class="fas fa-graduation-cap"></i><span id="label_area"> Área (Opcional)</span></label>
                    <select id="id_area" name="id_area" class="form-control"></select>
                </div>

                <div class="form-group" id="group_institucion" style="display:none">
                    <label for="id_institucion" class="form-label"><i class="fas fa-building"></i><span id="label_institucion"> Institución (Opcional)</span></label>
                    <div class="input-wrapper">
                        <select id="id_institucion" name="id_institucion" class="form-control">
                            <option value="">Sin institución específica</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="group_instituciones_multi" style="display:none">
                    <label for="id_instituciones" class="form-label"><i class="fas fa-building"></i><span> Instituciones adicionales (solo investigador)</span></label>
                    <div class="input-wrapper">
                        <select id="id_instituciones" name="id_instituciones" class="form-control" multiple></select>
                        <small class="text-muted">Selecciona una o más instituciones si perteneces a varias.</small>
                    </div>
                </div>
            </div>

            <!-- Fila 4 contraseñas -->
            <div class="form-row">
                <div class="form-group">
                    <label for="password" class="form-label"><i class="fas fa-lock"></i><span> Contraseña</span></label>
                    <div class="input-wrapper">
                        <input type="password" id="password" name="password" class="form-control" placeholder="Ingresa tu contraseña" required>
                    </div>
                    <div class="password-strength" id="passwordStrength"><div class="strength-bar" id="strengthBar"></div></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password" class="form-label"><i class="fas fa-lock"></i><span> Confirmar Contraseña</span></label>
                    <div class="input-wrapper">
                        <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder="Confirma tu contraseña" required>    
                    </div>
                </div>
            </div>

            <!-- Requisitos -->
            <div class="requirements-card">
                <h3><i class="fas fa-shield-alt"></i> Requisitos de la cuenta</h3>
                <ul class="requirements-list">
                    <li id="username-check"><i class="fas fa-check-circle"></i> Usuario válido (mínimo 3 caracteres)</li>
                    <li id="matricula-check"><i class="fas fa-check-circle"></i> Matrícula válida (8-10 caracteres alfanuméricos)</li>
                    <li id="email-check"><i class="fas fa-check-circle"></i> Correo electrónico válido</li>
                    <li id="phone-check"><i class="fas fa-check-circle"></i> Teléfono válido (10 dígitos)</li>
                    <li id="password-length"><i class="fas fa-check-circle"></i> Contraseña de 8-12 caracteres</li>
                    <li id="password-uppercase"><i class="fas fa-check-circle"></i> Al menos una letra mayúscula</li>
                    <li id="password-lowercase"><i class="fas fa-check-circle"></i> Al menos una letra minúscula</li>
                    <li id="password-special"><i class="fas fa-check-circle"></i> Al menos un carácter especial (.,*+$&#!)</li>
                    <li id="password-match"><i class="fas fa-check-circle"></i> Las contraseñas coinciden</li>
                    <li id="area-check"><i class="fas fa-check-circle"></i> Área seleccionada (opcional)</li>
                    <li id="institucion-check"><i class="fas fa-check-circle"></i> Institución seleccionada (opcional)</li>
                </ul>
            </div>

            <!-- Solicitudes de roles avanzados -->
            <div class="form-row">
                <div class="form-group" style="flex:1 1 100%">
                    <label class="form-label"><i class="fas fa-user-shield"></i><span> Solicitar roles avanzados (requiere aprobación)</span></label>
                    <div class="d-flex" style="gap:16px; flex-wrap:wrap">
                        <label class="d-flex align-items-center" style="gap:8px; display:none">
                            <input type="checkbox" name="wants_admin_inst" id="wants_admin_inst"> Usuario administrativo
                        </label>
                        <label class="d-flex align-items-center" style="gap:8px; display:none">
                            <input type="checkbox" name="wants_lab_admin" id="wants_lab_admin"> Admin de laboratorio
                        </label>
                        <div id="labSelector" style="display:none; gap:8px" class="d-flex align-items-center">
                            <select id="lab_id" name="lab_id" class="form-control" style="min-width:260px"></select>
                            <small class="text-muted">Selecciona el laboratorio que administrará</small>
                        </div>
                        <small id="labHelpHint" class="text-muted" style="display:none">El campo laboratorio solo aplica cuando seleccionas el rol "Administrador de laboratorio".</small>
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="form-actions flex-column-mobile">
                <button type="submit" class="login-btn" id="submitBtn">
                    <span class="btn-text"><i class="fas fa-user-plus"></i> Registrarse</span>
                </button>
                <a href="{{ url_for('auth.login') }}" class="register-btn mt-3">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Ya tengo cuenta</span>
                </a>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
    <!-- Script de Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
    // Variables globales
    let form, username, matricula, email, telefono, password, confirmPassword, area, institucion, userType;
    let usernameCheck, matriculaCheck, emailCheck, phoneCheck, passwordLength, passwordUppercase, passwordLowercase, passwordSpecial, passwordMatch, areaCheck, institucionCheck;
    let strengthBar, submitBtn;

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado - iniciando validaciones');
        
        // Obtener elementos del DOM
        form = document.getElementById('registerForm');
        username = document.getElementById('username');
        matricula = document.getElementById('matricula');
        email = document.getElementById('email');
        telefono = document.getElementById('telefono');
        password = document.getElementById('password');
        confirmPassword = document.getElementById('confirm_password');
        area = document.getElementById('id_area');
        institucion = document.getElementById('id_institucion');
        userType = document.getElementById('user_type');
        const wantsLabAdmin = document.getElementById('wants_lab_admin');
        const labSelector = document.getElementById('labSelector');
        const labSelect = document.getElementById('lab_id');
        
        // Elementos de validación
        usernameCheck = document.getElementById('username-check');
        matriculaCheck = document.getElementById('matricula-check');
        emailCheck = document.getElementById('email-check');
        phoneCheck = document.getElementById('phone-check');
        passwordLength = document.getElementById('password-length');
        passwordUppercase = document.getElementById('password-uppercase');
        passwordLowercase = document.getElementById('password-lowercase');
        passwordSpecial = document.getElementById('password-special');
        passwordMatch = document.getElementById('password-match');
        areaCheck = document.getElementById('area-check');
        institucionCheck = document.getElementById('institucion-check');
        
        // Barra de fuerza
        strengthBar = document.getElementById('strengthBar');
        
        // Botón de envío
        submitBtn = document.getElementById('submitBtn');

        // Verificar que todos los elementos existen (matricula puede no existir aún)
        if (!form || !username || !email || !telefono || !password || !confirmPassword || !submitBtn) {
            console.error('Error: No se encontraron todos los elementos del formulario');
            return;
        }

        console.log('Todos los elementos encontrados, configurando eventos');

        // Configurar eventos de validación
        username.addEventListener('input', function() {
            console.log('Validando usuario:', this.value);
            validateForm();
            actualizarProgreso();
        });
        
        matricula.addEventListener('input', function() {
            console.log('Validando matrícula:', this.value);
            validateForm();
            actualizarProgreso();
        });

        userType.addEventListener('change', applyTypeUI);

        // Escuchar cambios siempre (nativo) en institución/área
        if (institucion) {
            institucion.addEventListener('change', function() {
                console.log('[UI] Cambio institución (listener base):', institucion.value);
                const labSelectEl = document.getElementById('lab_id');
                if (labSelectEl) labSelectEl.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                cargarLaboratoriosPorInstitucion();
            });
        }
        if (area) {
            area.addEventListener('change', function() {
                console.log('[UI] Cambio área (listener base):', area.value);
                const labSelectEl = document.getElementById('lab_id');
                if (labSelectEl) labSelectEl.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                cargarLaboratoriosPorInstitucion();
            });
        }

        // Si Select2 está disponible, escuchar el evento select2:select también
        try {
            if (typeof $ !== 'undefined') {
                if ($('#id_institucion').length) {
                    $('#id_institucion').on('select2:select', function() {
                        console.log('[UI] Cambio institución (select2):', this.value);
                        const labSelectEl = document.getElementById('lab_id');
                        if (labSelectEl) labSelectEl.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                        cargarLaboratoriosPorInstitucion();
                    });
                }
                if ($('#id_area').length) {
                    $('#id_area').on('select2:select', function() {
                        console.log('[UI] Cambio área (select2):', this.value);
                        const labSelectEl = document.getElementById('lab_id');
                        if (labSelectEl) labSelectEl.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                        cargarLaboratoriosPorInstitucion();
                    });
                }
            }
        } catch (e) { console.warn('No se pudo adjuntar listeners select2:', e); }

        // Mostrar selector de laboratorio si solicita admin de laboratorio (compatibilidad)
        wantsLabAdmin.addEventListener('change', function() {
            labSelector.style.display = this.checked ? 'flex' : 'none';
            if (this.checked) {
                try { cargarLaboratoriosPorInstitucion(); } catch (e) { console.warn('No se pudo cargar labs (compat):', e); }
            }
        });
        
        email.addEventListener('input', function() {
            console.log('Validando email:', this.value);
            validateForm();
            actualizarProgreso();
        });
        
        telefono.addEventListener('input', function() {
            console.log('Validando teléfono:', this.value);
            validateForm();
            actualizarProgreso();
        });
        
        password.addEventListener('input', function() {
            console.log('Validando contraseña');
            validateForm();
            actualizarFuerza();
            actualizarProgreso();
        });
        
        confirmPassword.addEventListener('input', function() {
            console.log('Validando confirmación de contraseña');
            validateForm();
            actualizarProgreso();
        });

        // Eventos para otros campos
        const nombreEl = document.getElementById('nombre');
        const apPatEl = document.getElementById('apellido_paterno');
        const apMatEl = document.getElementById('apellido_materno');
        if (nombreEl) nombreEl.addEventListener('input', () => { validateForm(); actualizarProgreso(); });
        if (apPatEl) apPatEl.addEventListener('input', () => { validateForm(); actualizarProgreso(); });
        if (apMatEl) apMatEl.addEventListener('input', () => { validateForm(); actualizarProgreso(); });

        // Validar antes de enviar
        form.addEventListener('submit', function(e) {
            console.log('Enviando formulario, validando...');
            validateForm();
            
            const todosValidos = usernameCheck.classList.contains('valid') &&
                matriculaCheck.classList.contains('valid') &&
                emailCheck.classList.contains('valid') &&
                phoneCheck.classList.contains('valid') &&
                passwordLength.classList.contains('valid') &&
                passwordUppercase.classList.contains('valid') &&
                passwordLowercase.classList.contains('valid') &&
                passwordSpecial.classList.contains('valid') &&
                passwordMatch.classList.contains('valid'); // Área e institución removidas porque son opcionales
                
            if (!todosValidos) {
                e.preventDefault();
                alert('Por favor, completa todos los requisitos antes de registrarte.');
                console.log('Formulario no válido, enviado cancelado');
            } else {
                console.log('Formulario válido, enviando...');
            }
        });

        // Cargar datos
        cargarAreas();
        cargarInstituciones();
        // Si viene ya marcado desde atrás, cargar labs
        if (wantsLabAdmin.checked) cargarLaboratoriosPorInstitucion();
        // Aplicar UI inicial según tipo
        applyTypeUI();
        
        // Inicializar UI y validaciones
        applyTypeUI();
        validateForm();
        actualizarProgreso();
    });

    function setGroupVisibleById(groupId, visible) {
        const el = document.getElementById(groupId);
        if (el) el.style.display = visible ? '' : 'none';
    }

    function applyTypeUI() {
        const type = userType ? userType.value : '';
        const isStudent = type === 'estudiante';
        const isResearcher = type === 'investigador';
        const isTeacher = type === 'docente';
        const isAdminLab = type === 'admin_laboratorio';
        const isAdminInst = type === 'administrativo';

        // Sincronizar checkboxes de compatibilidad para backend
        const wantsAdminInst = document.getElementById('wants_admin_inst');
        const wantsLabAdmin = document.getElementById('wants_lab_admin');
        if (wantsAdminInst) wantsAdminInst.checked = isAdminInst;
        if (wantsLabAdmin) wantsLabAdmin.checked = isAdminLab;

        // Reset de valores cuando no hay rol seleccionado
        if (!type) {
            if (matricula) matricula.value = '';
            if (area) { try { $(area).val('').trigger('change'); } catch (_) { area.value = ''; } }
            if (institucion) { try { $(institucion).val('').trigger('change'); } catch (_) { institucion.value = ''; } }
            const labSelectReset = document.getElementById('lab_id');
            if (labSelectReset) labSelectReset.innerHTML = '<option value="">Selecciona un laboratorio</option>';
        }

        // Visibilidad de grupos
        setGroupVisibleById('group_matricula', isStudent);
        setGroupVisibleById('group_area',     isStudent || isTeacher || isResearcher || isAdminLab);
        setGroupVisibleById('group_institucion', isStudent || isTeacher || isResearcher || isAdminLab || isAdminInst);
        setGroupVisibleById('group_instituciones_multi', isResearcher);

        // Asteriscos/estados visuales
        const groupMat = document.getElementById('group_matricula');
        const groupArea = document.getElementById('group_area');
        const groupInst = document.getElementById('group_institucion');
        if (groupMat) groupMat.classList.toggle('required', isStudent);
        if (groupArea) groupArea.classList.toggle('required', (isResearcher || isAdminLab));
        if (groupInst) groupInst.classList.toggle('required', (isAdminLab || isAdminInst || isResearcher));
        // Requeridos y etiquetas
        const areaLabel = document.getElementById('label_area');
        const instLabel = document.getElementById('label_institucion');
        const matLabel = document.getElementById('label_matricula');
        if (matricula) matricula.required = isStudent;
        if (area) area.required = (isResearcher || isAdminLab);
        if (areaLabel) areaLabel.textContent = (isResearcher || isAdminLab) ? ' Área (Requerido)' : ' Área (Opcional)';
        if (institucion) institucion.required = (isAdminLab || isAdminInst || isResearcher);
        if (instLabel) instLabel.textContent = (isAdminLab || isAdminInst || isResearcher) ? ' Institución (Requerido)' : ' Institución (Opcional)';
        if (matLabel) matLabel.textContent = isStudent ? ' Matrícula (Requerido)' : ' Matrícula (Opcional)';

        // Carga condicional de catálogos al volverse visibles
        try {
            const instSelect = document.getElementById('id_institucion');
            if ((isAdminLab || isAdminInst || isResearcher) && instSelect && instSelect.options.length <= 1) {
                cargarInstituciones();
            }
        } catch (_) {}
        try {
            const areaSelect = document.getElementById('id_area');
            if ((isStudent || isTeacher || isResearcher || isAdminLab) && areaSelect && areaSelect.options.length <= 1) {
                cargarAreas();
            }
        } catch (_) {}

        // Selector de laboratorio
        const labSelector = document.getElementById('labSelector');
        if (labSelector) {
            labSelector.style.display = isAdminLab ? 'flex' : 'none';
            const labHelp = document.getElementById('labHelpHint');
            if (labHelp) labHelp.style.display = isAdminLab ? 'none' : 'block';
            const labSelect = document.getElementById('lab_id');
            if (isAdminLab) {
                // Si ya hay institución seleccionada, cargar laboratorios de inmediato
                cargarLaboratoriosPorInstitucion();
            } else {
                if (labSelect) labSelect.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                labSelector.classList.remove('invalid');
            }
        }

        validateForm();
        actualizarProgreso();
    }

    function validateForm() {
        console.log('Ejecutando validateForm');
        
        // Validar usuario
        if (username && username.value.length >= 3) {
            usernameCheck.classList.add('valid');
            console.log('Usuario válido');
        } else {
            usernameCheck.classList.remove('valid');
            console.log('Usuario inválido');
        }
        
        // Validar matrícula
        const matriculaRegex = /^[A-Z0-9]{8,10}$/i;
        const isStudent = userType && userType.value === 'estudiante';
        if (!isStudent) {
            matriculaCheck.classList.add('valid');
        } else if (matricula && matriculaRegex.test(matricula.value)) {
            matriculaCheck.classList.add('valid');
            console.log('Matrícula válida');
        } else {
            matriculaCheck.classList.remove('valid');
            console.log('Matrícula inválida');
        }

        // Marcar grupos como invalid/valid visualmente
        const groupMat = document.getElementById('group_matricula');
        const groupArea = document.getElementById('group_area');
        const groupInst = document.getElementById('group_institucion');
        if (groupMat) groupMat.classList.toggle('invalid', matricula && matricula.required && !matricula.value.trim());
        if (groupArea) groupArea.classList.toggle('invalid', area && area.required && (!area.value || area.value === ''));
        if (groupInst) groupInst.classList.toggle('invalid', institucion && institucion.required && (!institucion.value || institucion.value === ''));

        // Validar email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email && emailRegex.test(email.value)) {
            emailCheck.classList.add('valid');
            console.log('Email válido');
        } else {
            emailCheck.classList.remove('valid');
            console.log('Email inválido');
        }

        // Validar teléfono
        const phoneRegex = /^\d{10}$/;
        if (telefono && phoneRegex.test(telefono.value)) {
            phoneCheck.classList.add('valid');
            console.log('Teléfono válido');
        } else {
            phoneCheck.classList.remove('valid');
            console.log('Teléfono inválido');
        }

        // Validar longitud de contraseña (8-12 caracteres)
        if (password && password.value.length >= 8 && password.value.length <= 64) {
            passwordLength.classList.add('valid');
            console.log('Longitud de contraseña válida');
        } else {
            passwordLength.classList.remove('valid');
            console.log('Longitud de contraseña inválida');
        }
        
        // Validar letra mayúscula
        if (password && /[A-Z]/.test(password.value)) {
            passwordUppercase.classList.add('valid');
            console.log('Mayúscula válida');
        } else {
            passwordUppercase.classList.remove('valid');
            console.log('Falta mayúscula');
        }
        
        // Validar letra minúscula
        if (password && /[a-z]/.test(password.value)) {
            passwordLowercase.classList.add('valid');
            console.log('Minúscula válida');
        } else {
            passwordLowercase.classList.remove('valid');
            console.log('Falta minúscula');
        }
        
        // Validar carácter especial
        if (password && /[.,*+$&#!]/.test(password.value)) {
            passwordSpecial.classList.add('valid');
            console.log('Carácter especial válido');
        } else {
            passwordSpecial.classList.remove('valid');
            console.log('Falta carácter especial');
        }

        // Validar coincidencia de contraseñas
        if (password && confirmPassword && password.value === confirmPassword.value && password.value !== '') {
            passwordMatch.classList.add('valid');
            console.log('Contraseñas coinciden');
        } else {
            passwordMatch.classList.remove('valid');
            console.log('Contraseñas no coinciden');
        }

        // Validar área (opcional)
        const isResearcher = userType && userType.value === 'investigador';
        if (area && area.value !== '') {
            areaCheck.classList.add('valid');
            console.log('Área seleccionada');
        } else if (!isResearcher) {
            areaCheck.classList.add('valid'); // Siempre válida porque es opcional
            console.log('Área no seleccionada (opcional)');
        } else {
            areaCheck.classList.remove('valid');
            console.log('Área requerida para investigador');
        }

        // Validar institución (opcional)
        if (institucion && institucion.value !== '') {
            institucionCheck.classList.add('valid');
            console.log('Institución seleccionada');
        } else {
            institucionCheck.classList.add('valid'); // Siempre válida porque es opcional
            console.log('Institución no seleccionada (opcional)');
        }
        
        // Verificar si los campos visibles requeridos están llenos según el tipo
        const type = userType ? userType.value : 'normal';
        const typeIsStudent = type === 'estudiante';
        const typeIsResearcher = type === 'investigador';
        const typeIsTeacher = type === 'docente';
        const typeIsAdminLab = type === 'admin_laboratorio';
        const typeIsAdminInst = type === 'administrativo';

        const requeridos = [
            document.getElementById('nombre'),
            document.getElementById('apellido_paterno'),
            document.getElementById('apellido_materno'),
            username,
            email,
            telefono,
            password,
            confirmPassword
        ];
        if (typeIsStudent) requeridos.push(matricula);
        if (typeIsResearcher) requeridos.push(area);
        if (typeIsAdminLab || typeIsAdminInst || typeIsResearcher) requeridos.push(institucion);

        const todosLosCamposLlenos = requeridos.every(campo => campo && (campo.value || '').toString().trim() !== '');
        
        // Verificar si todas las validaciones están correctas
        const todasLasValidacionesCorrectas = 
            usernameCheck.classList.contains('valid') &&
            emailCheck.classList.contains('valid') &&
            phoneCheck.classList.contains('valid') &&
            passwordLength.classList.contains('valid') &&
            passwordUppercase.classList.contains('valid') &&
            passwordLowercase.classList.contains('valid') &&
            passwordSpecial.classList.contains('valid') &&
            passwordMatch.classList.contains('valid') &&
            // matrícula solo si es estudiante
            (!typeIsStudent || matriculaCheck.classList.contains('valid'));
        
        // Habilitar/deshabilitar botón
        const formularioCompleto = todosLosCamposLlenos && todasLasValidacionesCorrectas;
        
        if (submitBtn) {
            submitBtn.disabled = !formularioCompleto;
            
            if (formularioCompleto) {
                submitBtn.classList.remove('disabled');
                console.log('Formulario completo - botón habilitado');
            } else {
                submitBtn.classList.add('disabled');
                console.log('Formulario incompleto - botón deshabilitado');
            }
        }
    }

    function actualizarFuerza() {
        if (!password || !strengthBar) return;
        
        const val = password.value;
        let fuerza = 0;
        
        // Validar según los nuevos criterios
        if (val.length >= 8 && val.length <= 64) fuerza += 1; // Longitud correcta
        if (/[A-Z]/.test(val)) fuerza += 1; // Mayúscula
        if (/[a-z]/.test(val)) fuerza += 1; // Minúscula
        if (/[.,*+$&#!]/.test(val)) fuerza += 1; // Carácter especial específico
        
        const porcentajes = [0, 25, 50, 75, 100];
        strengthBar.style.width = porcentajes[fuerza] + '%';
        
        const colores = ['#dc3545', '#ff9800', '#ffc107', '#28a745', '#20c997'];
        strengthBar.style.background = colores[fuerza];
        
        console.log('Fuerza de contraseña:', fuerza, 'Porcentaje:', porcentajes[fuerza]);
    }

    function actualizarProgreso() {
        const campos = ['nombre', 'apellido_paterno', 'apellido_materno', 'username', 'matricula', 'email', 'telefono', 'id_area', 'id_institucion', 'password', 'confirm_password'];
        let completados = 0;
        
        campos.forEach(campo => {
            const elemento = document.getElementById(campo);
            if (elemento && elemento.value.trim() !== '') {
                completados++;
            }
        });
        
        const porcentaje = Math.round((completados / campos.length) * 100);
        document.documentElement.style.setProperty('--form-progress', porcentaje + '%');
        
        const progressText = document.getElementById('progressText');
        if (progressText) {
            progressText.textContent = porcentaje + '% completado';
        }
        
        console.log('Progreso actualizado:', porcentaje + '%');
    }

    // Función para cargar las áreas desde el API
    async function cargarAreas() {
        try {
            console.log('Cargando áreas...');
            const response = await fetch('/api/area/');
            const data = await response.json();
            
            const select = document.getElementById('id_area');
                select.innerHTML = '<option value="">Sin área específica</option>';
                
                if (data.success && data.areas) {
                    data.areas.forEach(area => {
                        const option = document.createElement('option');
                    option.value = area.id_area;
                    option.textContent = area.nombre_area;
                        select.appendChild(option);
                    });
                
                // Siempre adjuntar listener nativo de cambio
                if (select) {
                    select.addEventListener('change', function() {
                        console.log('Área cambiada:', select.value);
                        validateForm();
                        actualizarProgreso();
                        const labSelect = document.getElementById('lab_id');
                        if (labSelect) labSelect.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                        cargarLaboratoriosPorInstitucion();
                    });
                }

                // Inicializar Select2 si está disponible
                if (typeof $ !== 'undefined' && typeof $('#id_area').select2 === 'function') {
                    $('#id_area').select2({
                        placeholder: "Selecciona un área",
                        allowClear: true,
                        width: '100%'
                    });
                }
                
                console.log('Áreas cargadas exitosamente');
                } else {
                    select.innerHTML = '<option value="" disabled>No hay áreas disponibles</option>';
                }
        } catch (error) {
                console.error('Error al cargar áreas:', error);
            const select = document.getElementById('id_area');
                select.innerHTML = '<option value="" disabled>Error al cargar áreas</option>';
        }
    }

    // Función para cargar las instituciones desde el API
    async function cargarInstituciones() {
        try {
            console.log('Cargando instituciones...');
            const response = await fetch('/api/institucion/');
            const data = await response.json();
            
            const select = document.getElementById('id_institucion');
                select.innerHTML = '<option value="">Sin institución específica</option>';
                
                if (data.success && data.instituciones) {
                    data.instituciones.forEach(institucion => {
                        const option = document.createElement('option');
                    option.value = institucion.id_institucion;
                    option.textContent = institucion.nombre_institucion;
                        select.appendChild(option);
                    });
                
                // Siempre adjuntar listener nativo de cambio
                if (select) {
                    select.addEventListener('change', function() {
                        console.log('Institución cambiada:', select.value);
                        validateForm();
                        actualizarProgreso();
                        const labSelect = document.getElementById('lab_id');
                        if (labSelect) labSelect.innerHTML = '<option value="">Selecciona un laboratorio</option>';
                        cargarLaboratoriosPorInstitucion();
                    });
                }

                // Inicializar Select2 si está disponible
                if (typeof $ !== 'undefined' && typeof $('#id_institucion').select2 === 'function') {
                    $('#id_institucion').select2({
                        placeholder: "Selecciona una institución",
                        allowClear: true,
                        width: '100%'
                    });
                }
                // Poblar multi-select con el mismo catálogo
                const multi = document.getElementById('id_instituciones');
                if (multi) {
                    multi.innerHTML = '';
                    data.instituciones.forEach(inst => {
                        const opt = document.createElement('option');
                        opt.value = inst.id_institucion;
                        opt.textContent = inst.nombre_institucion;
                        multi.appendChild(opt);
                    });
                    try { $('#id_instituciones').select2({ placeholder: "Selecciona instituciones", width: '100%' }); } catch(_) {}
                }
                
                console.log('Instituciones cargadas exitosamente');
                } else {
                    select.innerHTML = '<option value="" disabled>No hay instituciones disponibles</option>';
                }
        } catch (error) {
                console.error('Error al cargar instituciones:', error);
            const select = document.getElementById('id_institucion');
                select.innerHTML = '<option value="" disabled>Error al cargar instituciones</option>';
        }
    }

    // Cargar laboratorios filtrados por institución (y opcionalmente área)
    async function cargarLaboratoriosPorInstitucion() {
        const labSelect = document.getElementById('lab_id');
        if (!labSelect) return;

        const idInst = (institucion && institucion.value) ? institucion.value : '';
        const idArea = (area && area.value) ? area.value : '';

        // Estado inicial
        labSelect.innerHTML = '<option value="">Selecciona un laboratorio</option>';

        if (!idInst) {
            labSelect.innerHTML = '<option value="" disabled>Selecciona una institución primero</option>';
            return;
        }

        try {
            const params = new URLSearchParams();
            if (idArea) params.set('id_area', idArea);
            const url = `/api/laboratorios/by_institucion/${encodeURIComponent(idInst)}${params.toString() ? '?' + params.toString() : ''}`;
            console.log('[Labs] Fetch URL:', url);
            const resp = await fetch(url);
            const data = await resp.json();
            console.log('[Labs] Response:', data);

            if (!data.success || !Array.isArray(data.laboratorios) || data.laboratorios.length === 0) {
                labSelect.innerHTML = '<option value="" disabled>No existen laboratorios en la institución seleccionada. Contacta al administrador de la app</option>';
                return;
            }

            // Si en el futuro filtramos por área, aquí podríamos filtrar data.laboratorios por idArea
            data.laboratorios.forEach(lab => {
                const option = document.createElement('option');
                option.value = lab.id_laboratorio;
                option.textContent = lab.nombre_laboratorio;
                labSelect.appendChild(option);
            });
        } catch (error) {
            labSelect.innerHTML = '<option value="" disabled>Error al cargar laboratorios</option>';
        }
    }
    
    // Función para cerrar mensajes flash
    function closeFlashMessage(button) {
        const message = button.closest('.flash-message');
        message.style.opacity = '0';
        message.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            message.style.display = 'none';
        }, 300);
    }

    async function descargarCatalogo() {
        try {
            window.location.href = '/api/institucion/download';
        } catch (error) {
            console.error('Error al descargar el catálogo:', error);
            alert('Error al descargar el catálogo');
        }
    }
</script>
{% endblock %}